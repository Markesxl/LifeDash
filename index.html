<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Life Dash v2.2 - Intelligence Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#38bdf8">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root {
  /* Design System Tokens */
  --glass-bg: rgba(255, 255, 255, 0.05);
  --glass-border: rgba(255, 255, 255, 0.1);
  --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  --glass-backdrop: blur(12px) saturate(180%);
  
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  
  --bg-sidebar: rgba(2, 6, 23, 0.85);
  --bg-main: rgba(11, 17, 32, 0.95);
  --card-bg: rgba(22, 30, 45, 0.7);
  --accent: #38bdf8;
  --text: #e5e7eb;
  --gold: #f59e0b;
  --danger: #ef4444;
  --success: #22c55e;
  --input-bg: rgba(15, 23, 42, 0.6);
  --purple: #a855f7;
  --orange: #fb923c;
  
  /* Espa√ßamento */
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  
  /* Bordas */
  --radius-sm: 12px;
  --radius-md: 16px;
  --radius-lg: 20px;
  --radius-xl: 28px;
  
  /* Efeitos */
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* Personaliza√ß√£o do Scroll */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: var(--radius-sm);
}

::-webkit-scrollbar-thumb {
  background: var(--primary-gradient);
  border-radius: var(--radius-sm);
  border: 2px solid rgba(255, 255, 255, 0.1);
}

::-webkit-scrollbar-thumb:hover {
  background: var(--accent-gradient);
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg-main);
  color: var(--text);
  display: flex;
  min-height: 100vh;
  overflow-x: hidden;
  background-image: 
    radial-gradient(at 40% 20%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),
    radial-gradient(at 80% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%),
    radial-gradient(at 0% 50%, rgba(34, 197, 94, 0.1) 0px, transparent 50%);
  backdrop-filter: blur(20px);
}

/* ==================== GLASSMORPHISM EFFECTS ==================== */
.glass {
  background: var(--glass-bg);
  backdrop-filter: var(--glass-backdrop);
  -webkit-backdrop-filter: var(--glass-backdrop);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
}

.glass-hover {
  transition: var(--transition);
}

.glass-hover:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
  box-shadow: 
    0 12px 40px rgba(0, 0, 0, 0.2),
    0 0 0 1px rgba(255, 255, 255, 0.1);
}

/* ==================== MENU MOBILE ==================== */
.menu-toggle {
  display: none;
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 3000;
  background: rgba(56, 189, 248, 0.15);
  color: var(--accent);
  border: 1px solid rgba(56, 189, 248, 0.3);
  width: 50px;
  height: 50px;
  border-radius: var(--radius-md);
  font-size: 24px;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  backdrop-filter: blur(10px);
}

.menu-toggle span {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  position: relative;
}

.menu-toggle span::before,
.menu-toggle span::after {
  content: '';
  position: absolute;
  width: 24px;
  height: 2px;
  background: var(--accent);
  border-radius: 1px;
  transition: var(--transition);
}

.menu-toggle span::before {
  top: 6px;
}

.menu-toggle span::after {
  bottom: 6px;
}

.menu-toggle span::before {
  top: 8px;
}

.menu-toggle span::after {
  bottom: 8px;
}

.menu-toggle:hover {
  background: rgba(56, 189, 248, 0.25);
  transform: scale(1.05);
}

.menu-toggle.open span::before {
  transform: rotate(45deg) translate(5px, 5px);
}

.menu-toggle.open span::after {
  transform: rotate(-45deg) translate(5px, -5px);
}

.menu-toggle.open span::before,
.menu-toggle.open span::after {
  top: 12px;
}

#mobile-logo {
  display: none;
  text-align: center;
  color: var(--accent);
  font-size: 28px;
  font-weight: 700;
  margin-bottom: var(--space-lg);
  letter-spacing: 1px;
  background: linear-gradient(135deg, #38bdf8, #a855f7);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

#menu-text {
  margin-left: var(--space-sm);
  font-size: 14px;
  color: var(--accent);
  opacity: 0;
  transform: translateX(-10px);
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  white-space: nowrap;
}

.menu-text-active {
  opacity: 1 !important;
  transform: translateX(0) !important;
}

/* ==================== SIDEBAR GLASS ==================== */
.sidebar {
  width: 280px;
  background: var(--bg-sidebar);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  padding: var(--space-xl);
  border-right: 1px solid rgba(255, 255, 255, 0.1);
  position: fixed;
  height: 100vh;
  z-index: 1500;
  transition: var(--transition);
  overflow-y: auto;
}

.sidebar h1 {
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 28px;
  margin-bottom: var(--space-xl);
  text-align: center;
  font-weight: 800;
  letter-spacing: 0.5px;
}

.nav button {
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.08);
  color: rgba(255, 255, 255, 0.7);
  padding: var(--space-md) var(--space-lg);
  text-align: left;
  border-radius: var(--radius-md);
  cursor: pointer;
  margin-bottom: var(--space-sm);
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: var(--space-md);
  transition: var(--transition);
  font-weight: 500;
  backdrop-filter: blur(10px);
}

.nav button:hover {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  transform: translateX(8px);
  border-color: rgba(255, 255, 255, 0.2);
}

.nav button.active {
  background: var(--primary-gradient);
  color: white;
  box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
  border: none;
}

.nav button .icon {
  font-size: 20px;
  width: 24px;
  text-align: center;
}

.main {
  flex: 1;
  padding: var(--space-xl);
  margin-left: 280px;
  min-width: 0;
  transition: var(--transition);
  max-width: 1400px;
}

.section {
  display: none;
  animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.section.active {
  display: block;
}

/* ==================== HEADER GRID GLASS ==================== */
.header-grid {
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: var(--space-lg);
  margin-bottom: var(--space-xl);
}

.card-slim {
  background: var(--card-bg);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: var(--radius-lg);
  padding: var(--space-lg) var(--space-xl);
  border: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  align-items: center;
  min-height: 160px;
  position: relative;
  transition: var(--transition);
  overflow: hidden;
}

.card-slim::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
}

.card-slim:hover {
  border-color: rgba(56, 189, 248, 0.4);
  box-shadow: 
    0 20px 40px rgba(0, 0, 0, 0.3),
    0 0 0 1px rgba(56, 189, 248, 0.1);
  transform: translateY(-4px);
}

.profile-img-slim {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  border: 3px solid transparent;
  background: var(--primary-gradient) border-box;
  object-fit: cover;
  flex-shrink: 0;
  margin-right: var(--space-lg);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  position: relative;
}

.profile-img-slim::before {
  content: '';
  position: absolute;
  inset: -3px;
  background: var(--primary-gradient);
  border-radius: 50%;
  z-index: -1;
}

.profile-info-slim {
  flex: 1;
  min-width: 0;
}

/* Perfil com nome destacado */
.profile-name-large {
  font-size: 24px;
  font-weight: 800;
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: var(--space-sm);
  line-height: 1.2;
}

.profile-details {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.7);
  margin-bottom: var(--space-sm);
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-md);
}

.profile-details span {
  padding-right: var(--space-md);
  border-right: 1px solid rgba(255, 255, 255, 0.1);
}

.profile-details span:last-child {
  border-right: none;
}

.phrase-slim {
  font-style: italic;
  font-size: 13px !important;
  margin-top: var(--space-sm) !important;
  color: rgba(255, 255, 255, 0.8);
  background: var(--accent-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 500;
}

/* ==================== XP BAR ANIMATED ==================== */
.xp-wrapper {
  margin-top: var(--space-md);
  width: 100%;
}

.xp-container {
  background: rgba(0, 0, 0, 0.3);
  border-radius: var(--radius-sm);
  height: 16px;
  overflow: hidden;
  margin-top: var(--space-sm);
  border: 1px solid rgba(255, 255, 255, 0.1);
  position: relative;
}

.xp-bar {
  background: var(--primary-gradient);
  background-size: 200% 100%;
  height: 100%;
  width: 0%;
  transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
  animation: xpShine 2s infinite linear;
  position: relative;
  overflow: hidden;
}

.xp-bar::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.4),
    transparent
  );
  animation: shine 2s infinite;
}

@keyframes xpShine {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

@keyframes shine {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ==================== CONQUISTAS GLASS ==================== */
.mini-conquistas {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-sm);
  margin: var(--space-sm) 0;
}

.badge-mini {
  width: 44px;
  height: 44px;
  border-radius: var(--radius-sm);
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  border: 2px solid transparent;
  background: linear-gradient(var(--card-bg), var(--card-bg)) padding-box,
              var(--primary-gradient) border-box;
  transition: var(--transition);
  cursor: pointer;
}

.badge-mini:hover {
  transform: scale(1.2) rotate(5deg);
  box-shadow: 0 8px 32px rgba(245, 158, 11, 0.4);
}

/* ==================== PHOTO UPLOAD GLASS ==================== */
.photo-upload-container {
  position: relative;
  width: 180px;
  height: 180px;
  margin: 0 auto;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 50%;
  overflow: hidden;
  border: 2px dashed rgba(255, 255, 255, 0.2);
  transition: var(--transition);
  backdrop-filter: blur(10px);
}

.photo-upload-container:hover {
  border-color: var(--accent);
  transform: scale(1.05);
  box-shadow: 0 0 40px rgba(56, 189, 248, 0.3);
}

.camera-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: var(--transition);
  font-size: 32px;
  color: white;
  backdrop-filter: blur(4px);
}

.photo-upload-container:hover .camera-overlay {
  opacity: 1;
}

.upload-label {
  font-size: 13px;
  background: var(--accent-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  display: block;
  margin: var(--space-sm) 0 var(--space-md);
  cursor: pointer;
  transition: var(--transition);
  text-align: center;
  font-weight: 600;
}

.upload-label:hover {
  transform: translateY(-2px);
}

/* ==================== CATEGORIAS E TAREFAS COM CORES DIFERENTES ==================== */
.cat-header {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  padding: var(--space-md) var(--space-lg);
  border-radius: var(--radius-md);
  margin-top: var(--space-lg);
  cursor: pointer;
  color: var(--accent);
  font-size: 15px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.cat-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    rgba(56, 189, 248, 0.1) 0%,
    rgba(56, 189, 248, 0.05) 50%,
    rgba(56, 189, 248, 0.1) 100%);
  opacity: 0;
  transition: var(--transition);
  z-index: -1;
}

.cat-header:hover::before {
  opacity: 1;
}

/* Cores √∫nicas para cada categoria */
.cat-header[data-color="0"] { border-left: 4px solid #667eea; }
.cat-header[data-color="1"] { border-left: 4px solid #f093fb; }
.cat-header[data-color="2"] { border-left: 4px solid #43e97b; }
.cat-header[data-color="3"] { border-left: 4px solid #fa709a; }
.cat-header[data-color="4"] { border-left: 4px solid #38f9d7; }
.cat-header[data-color="5"] { border-left: 4px solid #fee140; }
.cat-header[data-color="6"] { border-left: 4px solid #a855f7; }
.cat-header[data-color="7"] { border-left: 4px solid #fb923c; }

.cat-header:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateX(4px);
  border-color: rgba(255, 255, 255, 0.2);
}

.cat-done {
  background: linear-gradient(135deg, 
    rgba(34, 197, 94, 0.15) 0%, 
    rgba(34, 197, 94, 0.05) 100%);
  border-color: rgba(34, 197, 94, 0.3);
}

/* Task Container com anima√ß√£o suave */
.task-container-wrapper {
  max-height: 0;
  opacity: 0;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.05);
  border-top: none;
  border-radius: 0 0 var(--radius-md) var(--radius-md);
  padding: 0 var(--space-lg);
  margin-bottom: var(--space-sm);
  transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
              opacity 0.3s ease,
              padding 0.3s ease;
}

.task-container-wrapper.open {
  max-height: 1000px;
  opacity: 1;
  padding: var(--space-lg);
}

/* ==================== ITENS DE TAREFA COM SUBTAREFAS ==================== */
.task-item {
  margin-bottom: var(--space-md);
  padding: var(--space-md);
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.05);
  border-radius: var(--radius-md);
  transition: var(--transition);
}

.task-item:hover {
  background: rgba(255, 255, 255, 0.05);
}

.task-main-row {
  display: flex;
  align-items: center;
  gap: var(--space-md);
  margin-bottom: var(--space-sm);
}

.task-name {
  flex: 1;
  font-size: 15px;
  color: rgba(255, 255, 255, 0.9);
}

.task-description {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  margin-left: 52px;
  margin-bottom: var(--space-sm);
  line-height: 1.4;
  font-style: italic;
}

.subtask-container {
  margin-left: 52px;
  margin-top: var(--space-xs);
}

.subtask-item {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
  margin-bottom: var(--space-xs);
  padding: var(--space-xs) 0;
}

.subtask-name {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.7);
  flex: 1;
}

.subtask-checkbox {
  width: 16px;
  height: 16px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: rgba(255, 255, 255, 0.05);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.subtask-checkbox.checked {
  background: var(--success);
  border-color: var(--success);
}

.subtask-checkbox.checked::after {
  content: '‚úì';
  color: white;
  font-size: 10px;
  font-weight: bold;
}

/* ==================== SWITCH MODERNO COM ESPA√áAMENTO ==================== */
.switch-container {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.1);
  transition: var(--transition);
  border-radius: 24px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background: white;
  transition: var(--transition);
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

input:checked + .slider {
  background: var(--success-gradient);
  border-color: transparent;
}

input:checked + .slider:before {
  transform: translateX(20px);
}

/* ==================== HABITOS GLASS COM ESPA√áAMENTO CORRIGIDO ==================== */
.habit-name {
  font-weight: 600;
  font-size: 16px;
  color: white;
  letter-spacing: 0.3px;
}

.habit-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 var(--space-sm);
  margin-top: var(--space-md);
  table-layout: fixed;
  background: transparent;
}

.habit-table th {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.6);
  padding: var(--space-md) var(--space-sm);
  text-align: center;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: transparent;
}

.habit-table td {
  padding: var(--space-md) var(--space-sm);
  text-align: center;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.habit-table tr:first-child td {
  border-top-left-radius: var(--radius-sm);
  border-top-right-radius: var(--radius-sm);
}

.habit-table tr:last-child td {
  border-bottom-left-radius: var(--radius-sm);
  border-bottom-right-radius: var(--radius-sm);
}

.habit-circle {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.2);
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  transition: var(--transition);
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(4px);
}

.habit-circle.done {
  background: var(--success-gradient);
  border-color: transparent;
  color: white;
  box-shadow: 0 4px 20px rgba(67, 233, 123, 0.4);
  animation: pulse 1.5s infinite;
}

.habit-circle:hover:not(.done) {
  transform: scale(1.2);
  border-color: var(--accent);
  background: rgba(56, 189, 248, 0.1);
}

/* ==================== CARDS GLASS COM ESPA√áAMENTO ==================== */
.card {
  background: var(--card-bg);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: var(--radius-lg);
  padding: var(--space-xl);
  margin-bottom: var(--space-xl);
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(255, 255, 255, 0.3), 
    transparent);
}

.card:hover {
  border-color: rgba(56, 189, 248, 0.3);
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.3),
    0 0 0 1px rgba(56, 189, 248, 0.1);
  transform: translateY(-4px);
}

/* Cabe√ßalho do card com bot√£o de a√ß√£o */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-lg);
  padding-bottom: var(--space-md);
  border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.card-header h3 {
  color: var(--accent);
  font-size: 20px;
  margin: 0;
  display: flex;
  align-items: center;
  gap: var(--space-sm);
  font-weight: 700;
  background: linear-gradient(135deg, #38bdf8, #a855f7);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.card-toggle {
  background: none;
  border: none;
  color: var(--accent);
  font-size: 20px;
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
  transition: var(--transition);
}

.card-toggle:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: rotate(180deg);
}

.card-content {
  overflow: hidden;
  transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.card-content.collapsed {
  max-height: 0;
}

/* Bot√£o de a√ß√£o no card */
.card-action-button {
  position: absolute;
  top: var(--space-xl);
  right: var(--space-xl);
  width: 48px;
  height: 48px;
  border-radius: var(--radius-md);
  background: var(--primary-gradient);
  color: white;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: bold;
  transition: var(--transition);
  z-index: 10;
  box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
}

.card-action-button:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 12px 40px rgba(102, 126, 234, 0.5);
}

/* ==================== BOT√ïES GLASS ==================== */
.btn-primary {
  width: 100%;
  padding: var(--space-md) var(--space-lg);
  background: var(--primary-gradient);
  border: none;
  border-radius: var(--radius-md);
  font-weight: 700;
  cursor: pointer;
  color: white;
  transition: var(--transition);
  font-size: 16px;
  box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
  position: relative;
  overflow: hidden;
  z-index: 1;
}

.btn-primary::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(255, 255, 255, 0.2), 
    transparent);
  transition: left 0.5s;
  z-index: -1;
}

.btn-primary:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(102, 126, 234, 0.5);
}

.btn-primary:hover::before {
  left: 100%;
}

.btn-danger-outline {
  background: transparent;
  border: 2px solid var(--danger);
  color: var(--danger);
  padding: var(--space-md) var(--space-lg);
  border-radius: var(--radius-md);
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  width: 100%;
  font-size: 15px;
  position: relative;
  overflow: hidden;
}

.btn-danger-outline:hover {
  background: var(--danger);
  color: white;
  transform: translateY(-4px);
  box-shadow: 0 8px 32px rgba(239, 68, 68, 0.4);
}

.btn-gold-outline {
  background: transparent;
  border: 2px solid var(--gold);
  color: var(--gold);
  padding: var(--space-md) var(--space-lg);
  border-radius: var(--radius-md);
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  width: 100%;
  font-size: 15px;
}

.btn-gold-outline:hover {
  background: var(--gold);
  color: black;
  transform: translateY(-4px);
  box-shadow: 0 8px 32px rgba(245, 158, 11, 0.4);
}

.btn-plus {
  width: 48px !important;
  height: 48px !important;
  padding: 0 !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-size: 28px !important;
  line-height: 1 !important;
  font-weight: bold !important;
  border: none !important;
  cursor: pointer;
  flex-shrink: 0;
  border-radius: var(--radius-md) !important;
  background: var(--primary-gradient) !important;
  color: white !important;
  transition: var(--transition) !important;
}

.btn-plus:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
}

/* ==================== CONQUISTAS COMPACTAS ==================== */
.badge-category {
  margin-bottom: var(--space-xl);
}

.badge-category-title {
  font-size: 16px;
  font-weight: 800;
  background: var(--accent-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-transform: uppercase;
  margin-bottom: var(--space-lg);
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.badge-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: var(--space-md);
}

.badge-card {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(20px);
  padding: var(--space-md);
  border-radius: var(--radius-md);
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: var(--transition);
  cursor: pointer;
  position: relative;
  overflow: hidden;
  min-height: 160px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.badge-card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--primary-gradient);
  opacity: 0;
  transition: var(--transition);
  z-index: -1;
}

.badge-card.unlocked {
  border-color: transparent;
  background: linear-gradient(var(--card-bg), var(--card-bg)) padding-box,
              var(--primary-gradient) border-box;
  box-shadow: 0 8px 32px rgba(102, 126, 234, 0.2);
}

.badge-card.unlocked:hover {
  transform: translateY(-8px);
  box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
}

.badge-card.locked {
  opacity: 0.6;
  filter: grayscale(0.5);
}

.badge-card.locked:hover {
  opacity: 0.8;
  filter: grayscale(0.3);
}

.badge-icon {
  font-size: 36px;
  margin-bottom: var(--space-sm);
  display: block;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
}

.badge-title {
  font-size: 13px;
  font-weight: 700;
  color: white;
  margin-bottom: var(--space-xs);
  line-height: 1.2;
}

.badge-desc {
  font-size: 10px;
  color: rgba(255, 255, 255, 0.6);
  line-height: 1.3;
  margin-bottom: var(--space-xs);
}

.badge-progress {
  margin-top: var(--space-sm);
  padding-top: var(--space-sm);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.badge-progress-bar {
  background: rgba(0, 0, 0, 0.2);
  border-radius: var(--radius-sm);
  height: 6px;
  overflow: hidden;
  margin-top: var(--space-xs);
}

.badge-progress-fill {
  background: var(--primary-gradient);
  height: 100%;
  transition: width 0.5s ease;
  position: relative;
  overflow: hidden;
}

.badge-progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.3),
    transparent
  );
  animation: shine 2s infinite;
}

/* ==================== MODO FOCO (POMODORO) ==================== */
#focoOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(20px);
  z-index: 10000;
  display: none;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.foco-container {
  background: rgba(22, 30, 45, 0.9);
  backdrop-filter: blur(40px);
  border-radius: var(--radius-xl);
  padding: var(--space-xl);
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 
    0 40px 80px rgba(0, 0, 0, 0.5),
    0 0 0 1px rgba(255, 255, 255, 0.05);
  max-width: 500px;
  width: 90%;
  animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.foco-timer {
  font-size: 96px;
  font-weight: 800;
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin: var(--space-xl) 0;
  text-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
  animation: pulse 2s infinite;
}

.foco-botoes {
  display: flex;
  gap: var(--space-md);
  justify-content: center;
  margin-top: var(--space-xl);
}

/* ==================== AUTH GLASS ==================== */
#login-screen {
  position: fixed;
  inset: 0;
  background: radial-gradient(ellipse at top, rgba(2, 6, 23, 0.95), rgba(11, 17, 32, 1));
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow-y: auto;
  padding: var(--space-xl);
  backdrop-filter: blur(20px);
}

.login-box {
  background: rgba(22, 30, 45, 0.8);
  backdrop-filter: blur(40px);
  padding: var(--space-xl);
  border-radius: var(--radius-xl);
  border: 1px solid rgba(255, 255, 255, 0.1);
  width: 100%;
  max-width: 480px;
  text-align: center;
  box-shadow: 
    0 40px 80px rgba(0, 0, 0, 0.5),
    0 0 0 1px rgba(255, 255, 255, 0.05);
  animation: slideInRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.login-box h1 {
  font-size: 40px;
  margin-bottom: var(--space-sm);
  font-weight: 800;
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.login-box h2 {
  color: rgba(255, 255, 255, 0.8);
  font-size: 22px;
  margin-bottom: var(--space-xl);
  font-weight: 500;
}

input, select, textarea {
  width: 100%;
  padding: var(--space-md) var(--space-lg);
  border-radius: var(--radius-md);
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.05);
  color: white;
  margin-bottom: var(--space-md);
  font-size: 16px;
  transition: var(--transition);
  backdrop-filter: blur(10px);
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

select {
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  background-size: 1em;
  padding-right: 2.5rem;
}

textarea {
  resize: vertical;
  min-height: 80px;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 
    0 0 0 3px rgba(56, 189, 248, 0.1),
    0 8px 32px rgba(56, 189, 248, 0.2);
  background: rgba(255, 255, 255, 0.08);
}

.grid-stack {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-xl);
  align-items: start;
}

/* ==================== MODAIS DE REGISTRO ==================== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  z-index: 2000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: var(--space-md);
  animation: fadeIn 0.3s ease;
}

.modal-content {
  background: var(--card-bg);
  backdrop-filter: blur(40px);
  border-radius: var(--radius-lg);
  padding: var(--space-xl);
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-lg);
  padding-bottom: var(--space-md);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header h3 {
  margin: 0;
  border: none;
  padding: 0;
  cursor: default;
}

.modal-close {
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.6);
  font-size: 24px;
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
  transition: var(--transition);
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.modal-form-group {
  margin-bottom: var(--space-lg);
}

.modal-label {
  display: block;
  color: var(--accent);
  font-size: 13px;
  font-weight: 700;
  margin-bottom: var(--space-sm);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* ==================== HIST√ìRICO AVAN√áADO ==================== */
.historico-filtros {
  display: flex;
  gap: var(--space-md);
  margin-bottom: var(--space-lg);
  flex-wrap: wrap;
}

.filtro-input {
  flex: 1;
  min-width: 200px;
}

.filtro-select {
  min-width: 150px;
}

.historico-estatisticas {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: var(--space-md);
  margin-bottom: var(--space-lg);
}

.estatistica-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--radius-md);
  padding: var(--space-md);
  text-align: center;
  transition: var(--transition);
}

.estatistica-card:hover {
  background: rgba(255, 255, 255, 0.05);
  transform: translateY(-2px);
}

.estatistica-valor {
  font-size: 28px;
  font-weight: 800;
  margin-bottom: var(--space-xs);
}

.estatistica-label {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.historico-lista {
  max-height: 500px;
  overflow-y: auto;
  margin-top: var(--space-lg);
}

.historico-item {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--radius-md);
  padding: var(--space-md);
  margin-bottom: var(--space-sm);
  transition: var(--transition);
}

.historico-item:hover {
  background: rgba(255, 255, 255, 0.05);
  transform: translateX(4px);
}

.historico-tipo {
  display: inline-block;
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  margin-right: var(--space-sm);
}

.historico-tipo-tarefa { background: rgba(56, 189, 248, 0.2); color: var(--accent); }
.historico-tipo-habito { background: rgba(34, 197, 94, 0.2); color: var(--success); }
.historico-tipo-pomodoro { background: rgba(245, 158, 11, 0.2); color: var(--gold); }

/* ==================== MOBILE RESPONSIVO CORRIGIDO ==================== */
@media (max-width: 1090px) {
  .menu-toggle {
    display: flex !important;
    top: 15px;
    left: 15px;
    width: 46px;
    height: 46px;
  }
  
  #mobile-logo {
    display: block;
    padding-top: 70px;
    text-align: center;
    font-size: 24px;
    margin-bottom: var(--space-lg);
  }
  
  .sidebar {
    left: -280px;
    padding-top: 80px;
    width: 260px;
  }
  
  .sidebar.open {
    left: 0;
    box-shadow: 0 0 0 10000px rgba(0, 0, 0, 0.9);
  }
  
  .sidebar h1 {
    display: none;
  }
  
  .main {
    margin-left: 0;
    padding: 80px var(--space-md) var(--space-xl);
    width: 100%;
  }
  
  .header-grid {
    grid-template-columns: 1fr;
    gap: var(--space-md);
  }
  
  .card-slim:nth-child(1) {
    order: 1;
  }
  
  .card-slim:nth-child(2) {
    display: none !important;
  }
  
  .mobile-badges-container {
    display: block;
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .grid-stack {
    grid-template-columns: 1fr !important;
    gap: var(--space-lg);
  }
  
  .card {
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
  }
  
  h3 {
    font-size: 18px;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
  }
  
  .badge-grid {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: var(--space-sm);
  }
  
  /* Habitos mobile otimizado - SEM SOBREPOSI√á√ÉO */
  .habit-circle {
    width: 30px !important;
    height: 30px !important;
    min-width: 30px !important;
    min-height: 30px !important;
    font-size: 14px !important;
    margin: 0 auto;
  }
  
  .habit-table {
    border-spacing: 0 4px;
    width: 100%;
    margin-left: 0;
    margin-right: 0;
  }
  
  .habit-table th,
  .habit-table td {
    padding: var(--space-xs) 2px !important;
  }
  
  .habit-table th {
    font-size: 9px !important;
    padding-bottom: 2px !important;
  }
  
  .habit-name {
    font-size: 12px !important;
    padding-left: 0;
    line-height: 1.2;
  }
  
  /* Ajuste do header de h√°bitos */
  .habit-table th:first-child {
    width: 40% !important;
    text-align: left !important;
    padding-left: 4px !important;
  }
  
  /* Garantir que n√£o corte nas bordas */
  .card {
    overflow: visible !important;
  }
  
  /* Ajuste dos switches no mobile */
  .switch {
    transform: scale(0.9);
    margin-left: 0;
  }
  
  .task-item {
    padding: var(--space-sm);
    margin-bottom: var(--space-sm);
  }
  
  .task-name {
    font-size: 13px;
  }
  
  .subtask-container {
    margin-left: 44px;
  }
  
  .subtask-name {
    font-size: 12px;
  }
  
  /* Melhor alinhamento do menu toggle */
  .menu-toggle {
    align-items: center;
    justify-content: center;
  }
  
  #menu-text {
    display: none;
  }
  
  /* Espa√ßamento interno dos cards melhorado */
  .cat-header {
    padding: var(--space-sm) var(--space-md);
    margin-top: var(--space-sm);
    font-size: 13px;
  }
  
  .task-container-wrapper.open {
    padding: var(--space-md);
  }
  
  /* Hist√≥rico mobile */
  .historico-filtros {
    flex-direction: column;
    gap: var(--space-sm);
  }
  
  .filtro-input,
  .filtro-select {
    min-width: 100%;
  }
  
  .historico-estatisticas {
    grid-template-columns: repeat(2, 1fr);
  }
  
  /* Modais mobile */
  .modal-content {
    padding: var(--space-lg);
    max-height: 85vh;
  }
  
  /* Bot√µes de a√ß√£o no mobile */
  .card-action-button {
    width: 40px;
    height: 40px;
    font-size: 20px;
    top: var(--space-lg);
    right: var(--space-lg);
  }
  
  /* Perfil mobile */
  .profile-name-large {
    font-size: 20px;
  }
  
  .profile-details {
    font-size: 12px;
    gap: var(--space-sm);
  }
}

.mobile-badges-container {
  display: none;
}

@media (max-width: 1090px) {
  .mobile-badges-container {
    display: block;
  }
}

/* ==================== ANIMA√á√ïES ==================== */
@keyframes fadeIn {
  from { 
    opacity: 0; 
    transform: translateY(20px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

@keyframes slideDown {
  from { 
    opacity: 0; 
    max-height: 0; 
  }
  to { 
    opacity: 1; 
    max-height: 1000px; 
  }
}

@keyframes scaleIn {
  from { 
    transform: scale(0.8); 
    opacity: 0; 
  }
  to { 
    transform: scale(1); 
    opacity: 1; 
  }
}

@keyframes bounceIn {
  0% { 
    transform: scale(0) rotate(-180deg); 
  }
  50% { 
    transform: scale(1.1) rotate(10deg); 
  }
  100% { 
    transform: scale(1) rotate(0deg); 
  }
}

@keyframes pulse {
  0%, 100% { 
    transform: scale(1); 
  }
  50% { 
    transform: scale(1.05); 
  }
}

@keyframes rotate {
  from { 
    transform: rotate(0deg); 
  }
  to { 
    transform: rotate(360deg); 
  }
}

@keyframes slideInRight {
  from { 
    transform: translateX(100px); 
    opacity: 0; 
  }
  to { 
    transform: translateX(0); 
    opacity: 1; 
  }
}

@keyframes slideOutRight {
  from { 
    transform: translateX(0); 
    opacity: 1; 
  }
  to { 
    transform: translateX(100px); 
    opacity: 0; 
  }
}

@keyframes float {
  0%, 100% { 
    transform: translateY(0px); 
  }
  50% { 
    transform: translateY(-10px); 
  }
}

/* ==================== SKELETONS ==================== */
.skeleton {
  animation: skeleton-pulse 1.5s ease-in-out infinite;
  background: linear-gradient(90deg, 
    rgba(255, 255, 255, 0.05) 0%,
    rgba(255, 255, 255, 0.1) 50%,
    rgba(255, 255, 255, 0.05) 100%);
  background-size: 200% 100%;
  border-radius: var(--radius-md);
}

@keyframes skeleton-pulse {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

.skeleton-line {
  animation: skeleton-pulse 1.5s ease-in-out infinite;
  background: linear-gradient(90deg, 
    rgba(255, 255, 255, 0.05) 0%,
    rgba(255, 255, 255, 0.1) 50%,
    rgba(255, 255, 255, 0.05) 100%);
  background-size: 200% 100%;
  border-radius: var(--radius-sm);
}

.skeleton-badge {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  animation: skeleton-pulse 1.5s ease-in-out infinite;
  background: linear-gradient(90deg, 
    rgba(255, 255, 255, 0.05) 0%,
    rgba(255, 255, 255, 0.1) 50%,
    rgba(255, 255, 255, 0.05) 100%);
  background-size: 200% 100%;
}

.skeleton-cat {
  height: 48px;
  border-radius: var(--radius-md);
  animation: skeleton-pulse 1.5s ease-in-out infinite;
  background: linear-gradient(90deg, 
    rgba(255, 255, 255, 0.05) 0%,
    rgba(255, 255, 255, 0.1) 50%,
    rgba(255, 255, 255, 0.05) 100%);
  background-size: 200% 100%;
}

.skeleton-task {
  height: 56px;
  border-radius: var(--radius-md);
  margin-bottom: var(--space-sm);
  animation: skeleton-pulse 1.5s ease-in-out infinite;
  background: linear-gradient(90deg, 
    rgba(255, 255, 255, 0.05) 0%,
    rgba(255, 255, 255, 0.1) 50%,
    rgba(255, 255, 255, 0.05) 100%);
  background-size: 200% 100%;
}

.skeleton-habit-row {
  height: 68px;
  border-radius: var(--radius-md);
  margin-bottom: var(--space-md);
  animation: skeleton-pulse 1.5s ease-in-out infinite;
  background: linear-gradient(90deg, 
    rgba(255, 255, 255, 0.05) 0%,
    rgba(255, 255, 255, 0.1) 50%,
    rgba(255, 255, 255, 0.05) 100%);
  background-size: 200% 100%;
}

.skeleton-badge-card {
  height: 140px;
  border-radius: var(--radius-md);
  animation: skeleton-pulse 1.5s ease-in-out infinite;
  background: linear-gradient(90deg, 
    rgba(255, 255, 255, 0.05) 0%,
    rgba(255, 255, 255, 0.1) 50%,
    rgba(255, 255, 255, 0.05) 100%);
  background-size: 200% 100%;
}

.skeleton-category {
  margin-bottom: var(--space-xl);
}

/* ==================== LOADING OVERLAY ==================== */
.spinner {
  display: inline-block;
  width: 32px;
  height: 32px;
  border: 3px solid rgba(56, 189, 248, 0.3);
  border-radius: 50%;
  border-top-color: var(--accent);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(2, 6, 23, 0.95);
  backdrop-filter: blur(20px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.loading-overlay.active {
  opacity: 1;
  visibility: visible;
}

.loading-content {
  text-align: center;
  padding: var(--space-xl);
  background: rgba(22, 30, 45, 0.9);
  backdrop-filter: blur(40px);
  border-radius: var(--radius-xl);
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 40px 80px rgba(0, 0, 0, 0.5);
  animation: float 3s ease-in-out infinite;
}

/* ==================== TOAST NOTIFICATIONS ==================== */
.toast {
  position: fixed;
  bottom: var(--space-xl);
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: rgba(22, 30, 45, 0.95);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--radius-md);
  padding: var(--space-md) var(--space-lg);
  min-width: 300px;
  max-width: 90vw;
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.3),
    0 0 0 1px rgba(255, 255, 255, 0.05);
  z-index: 10000;
  display: flex;
  align-items: center;
  gap: var(--space-md);
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.toast-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.toast-success { 
  border-color: rgba(34, 197, 94, 0.3); 
}

.toast-error { 
  border-color: rgba(239, 68, 68, 0.3); 
}

.toast-warning { 
  border-color: rgba(245, 158, 11, 0.3); 
}

.toast-info { 
  border-color: rgba(56, 189, 248, 0.3); 
}

/* ==================== ESTADOS VAZIOS ==================== */
.empty-state {
  text-align: center;
  padding: var(--space-xl) var(--space-lg);
  color: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(10px);
  border-radius: var(--radius-md);
  border: 1px dashed rgba(255, 255, 255, 0.1);
}

.empty-state-icon {
  font-size: 56px;
  margin-bottom: var(--space-lg);
  opacity: 0.3;
  animation: float 3s ease-in-out infinite;
}

.empty-state-title {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: var(--space-sm);
  color: rgba(255, 255, 255, 0.8);
}

.empty-state-description {
  font-size: 15px;
  max-width: 300px;
  margin: 0 auto;
  line-height: 1.6;
  color: rgba(255, 255, 255, 0.6);
}

/* ==================== GESTOS TOUCH ==================== */
.touch-target {
  min-height: 48px;
  min-width: 48px;
}

/* ==================== CONTROLE DE VISIBILIDADE ==================== */
.mobile-only {
  display: none !important;
}

.desktop-only {
  display: block !important;
}

@media (max-width: 1090px) {
  .mobile-only {
    display: block !important;
  }
  
  .desktop-only {
    display: none !important;
  }
}

@media (min-width: 1091px) {
  .card-slim:nth-child(2) {
    display: flex !important;
  }
}

/* ==================== POPUP ==================== */
#popup {
  position: fixed;
  top: var(--space-lg);
  right: var(--space-lg);
  padding: var(--space-md) var(--space-lg);
  border-radius: var(--radius-md);
  font-weight: 600;
  display: none;
  z-index: 9999;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  font-size: 15px;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
</style>
</head>
<body>

<button class="menu-toggle" onclick="toggleSidebar()">
  <span></span>
  <small id="menu-text">Menu</small>
</button>

<div id="login-screen">
  <div class="login-box" id="auth-login">
    <h1>LIFE DASH</h1>
    <h2>Bem-vindo de volta!</h2>
    <input type="email" id="login-email" placeholder="Seu e-mail">
    <input type="password" id="login-password" placeholder="Sua senha">
    <button class="btn-primary" onclick="fazerLogin()">Entrar</button>
    <p onclick="recuperarSenha()" style="color: var(--accent); cursor: pointer; font-size: 14px; margin-top: var(--space-lg);">Esqueci minha senha</p>
    <span onclick="toggleAuth('register')" style="color: var(--accent); cursor: pointer; text-decoration: underline; font-size: 14px; margin-top: var(--space-md); display: block;">Criar nova conta</span>
  </div>

  <div class="login-box" id="auth-register" style="display: none;">
    <h2>Criar Conta</h2>
    <div class="photo-upload-container" onclick="document.getElementById('regFoto').click()">
        <img id="regPreview" src="" style="width:100%; height:100%; border-radius:50%; object-fit:cover; display:none;">
        <div class="camera-overlay" style="opacity: 1;">üì∑</div>
    </div>
    <span class="upload-label" onclick="document.getElementById('regFoto').click()">Adicionar foto de perfil</span>
    <input type="file" id="regFoto" onchange="previewRegistro(this)" style="display:none;" accept="image/*">
    <input type="text" id="regNome" placeholder="Nome completo">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
        <input type="date" id="regNascimento">
        <select id="regSexo"><option value="">Sexo...</option><option>Masculino</option><option>Feminino</option><option>Outro</option></select>
    </div>
    <input type="text" id="regProfissao" placeholder="Profiss√£o">
    <input type="email" id="regEmail" placeholder="E-mail">
    <input type="password" id="regPassword" placeholder="Senha (m√≠nimo 6 caracteres)">
    <button class="btn-primary" onclick="fazerRegistro()">Criar Conta</button>
    <span onclick="toggleAuth('login')" style="color: var(--accent); cursor: pointer; text-decoration: underline; font-size: 14px; margin-top: var(--space-lg); display: block;">J√° tem conta? Fa√ßa login</span>
  </div>
</div>

<div class="sidebar">
  <h1>LIFE DASH</h1>
  <div class="nav">
    <button class="active" onclick="irPara('home', this)"><span class="icon">üè†</span> Home</button>
    <button onclick="irPara('conquistas', this)"><span class="icon">üèÜ</span> Conquistas</button>
    <button onclick="irPara('perfil', this)"><span class="icon">üë§</span> Perfil</button>
    <button onclick="irPara('historico', this)"><span class="icon">üìú</span> Hist√≥rico</button>
    <button onclick="irPara('modofoco', this)" id="modoFocoBtn"><span class="icon">üçÖ</span> Modo Foco</button>
    <button onclick="fazerLogout()" style="margin-top: 40px; color: var(--danger);"><span class="icon">üö™</span> Sair</button>
  </div>
</div>

<div class="main">
  <div id="mobile-logo">LIFE DASH</div>
  
  <div class="header-grid">
    <!-- Card do Perfil -->
    <div class="card-slim">
      <div id="hFotoSkeleton" class="profile-img-slim skeleton" style="border:none;"></div>
      <img id="hFoto" class="profile-img-slim" src="" style="display:none;">
      
      <div class="profile-info-slim">
        <div id="profileInfoReal" style="display: none;">
          <div class="profile-name-large" id="hNome">---</div>
          <div class="profile-details">
            <span><strong>Idade:</strong> <span id="hIdade">--</span></span>
            <span><strong>Sexo:</strong> <span id="hSexo">---</span></span>
            <span><strong>Profiss√£o:</strong> <span id="hProfissao">---</span></span>
          </div>
          <p id="hFrase" class="phrase-slim">"---"</p>
        </div>
        
        <div id="profileInfoSkeleton">
          <div class="skeleton-line" style="width:70%; height:24px; margin-bottom:var(--space-sm);"></div>
          <div class="skeleton-line" style="width:60%; height:18px; margin-bottom:var(--space-sm);"></div>
          <div class="skeleton-line" style="width:50%; height:14px; margin-bottom:var(--space-md);"></div>
        </div>
        
        <!-- Badges Mobile -->
        <div id="mobileBadgesReal" class="mobile-badges-container mobile-only" style="display: none;">
          <div style="font-size: 12px; color: var(--accent); margin-bottom: var(--space-sm); font-weight: 700;">üèÜ CONQUISTAS</div>
          <div id="homeBadgesMobile" class="mini-conquistas"></div>
        </div>

        <!-- Skeleton Mobile Badges -->
        <div id="mobileBadgesSkeleton" class="mobile-badges-container">
          <div style="font-size: 12px; color: var(--accent); margin-bottom: var(--space-sm); font-weight: 700;">üèÜ CONQUISTAS</div>
          <div style="display:flex; gap:var(--space-sm);">
            <div class="skeleton-badge"></div>
            <div class="skeleton-badge"></div>
            <div class="skeleton-badge"></div>
          </div>
        </div>
        
        <!-- XP Info Real -->
        <div id="xpInfoReal" class="xp-wrapper" style="display: none;">
          <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--accent); font-weight:600">
            <span>N√≠vel <b id="hNivel">1</b></span>
            <span id="xpNumerico">0/100 XP</span>
          </div>
          <div class="xp-container">
            <div id="xpBar" class="xp-bar" style="width: 0%;"></div>
          </div>
        </div>
        
        <!-- XP Skeleton -->
        <div id="xpInfoSkeleton" class="xp-wrapper">
          <div style="display:flex; justify-content:space-between; margin-bottom:var(--space-sm);">
            <div class="skeleton-line" style="width:50px; height:14px;"></div>
            <div class="skeleton-line" style="width:70px; height:14px;"></div>
          </div>
          <div class="skeleton-line" style="width:100%; height:16px; border-radius:var(--radius-sm);"></div>
        </div>
      </div>
    </div>

    <!-- Card de Conquistas Recentes -->
    <div class="card-slim" style="flex-direction: column; align-items: flex-start; justify-content: center;">
      <h3 style="margin-bottom: var(--space-md); font-size: 16px; border:none; padding:0; cursor:default; display: none;" id="conquistasTitulo">üèÜ Conquistas Recentes</h3>
      
      <div class="skeleton-line" style="width:160px; height:20px; margin-bottom:var(--space-md);"></div>
      
      <div id="homeBadges" class="mini-conquistas" style="display: none;"></div>
      
      <div id="badgesSkeleton" style="display:flex; gap:var(--space-sm); flex-wrap:wrap;">
        <div class="skeleton-badge"></div>
        <div class="skeleton-badge"></div>
        <div class="skeleton-badge"></div>
      </div>
    </div>
  </div>

  <!-- ==================== SE√á√ÉO HOME ==================== -->
  <div id="home" class="section active">
    <div class="grid-stack">
      <!-- Card de Tarefas -->
      <div class="card">
        <button class="card-action-button" onclick="abrirModalTarefas()" title="Registrar Tarefas">+</button>
        <div class="card-header">
          <h3>üöÄ Tarefas do Dia</h3>
          <button class="card-toggle" onclick="toggleCardContent('homeTarefasCont', this)">‚ñº</button>
        </div>
        <div id="homeTarefasCont" class="card-content">
          <div id="tarefasSkeleton">
            <div class="skeleton-cat" style="margin-bottom:var(--space-md);"></div>
            <div class="skeleton-task"></div>
            <div class="skeleton-task"></div>
            <div class="skeleton-task"></div>
          </div>
          <div id="homeTarefas" style="display:none;"></div>
        </div>
      </div>
      
      <!-- Card de H√°bitos -->
      <div class="card">
        <button class="card-action-button" onclick="abrirModalHabitos()" title="Registrar H√°bitos">+</button>
        <div class="card-header">
          <h3>‚ú® H√°bitos Ativos</h3>
          <button class="card-toggle" onclick="toggleCardContent('homeHabitosCont', this)">‚ñº</button>
        </div>
        <div id="homeHabitosCont" class="card-content">
          <div id="habitosSkeleton">
            <div style="display:flex; gap:var(--space-md); margin-bottom:var(--space-lg);">
              <div class="skeleton-line" style="width:120px; height:24px;"></div>
              <div class="skeleton-line" style="width:100px; height:24px;"></div>
              <div class="skeleton-line" style="width:80px; height:24px;"></div>
            </div>
            <div class="skeleton-habit-row"></div>
            <div class="skeleton-habit-row"></div>
            <div class="skeleton-habit-row"></div>
          </div>
          <table class="habit-table" style="display:none;">
            <thead id="habitHead"></thead>
            <tbody id="homeHabitos"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== SE√á√ÉO PERFIL ==================== -->
  <div id="perfil" class="section">
    <div class="card">
      <h3 style="cursor: default;">üë§ Editar Perfil</h3>
      <div class="grid-stack">
        <div style="text-align: center;">
          <div class="photo-upload-container" onclick="document.getElementById('pFotoInput').click()">
            <img id="pPreview" src="" style="width:100%; height:100%; border-radius:50%; object-fit: cover; display:none;">
            <div class="camera-overlay" id="pCameraIcon" style="opacity: 1;">üì∑</div>
          </div>
          <span class="upload-label" onclick="document.getElementById('pFotoInput').click()">Alterar foto</span>
          <input type="file" id="pFotoInput" onchange="localPreview(this)" style="display:none;" accept="image/*">
        </div>
        <div>
          <input id="pNome" placeholder="Nome completo">
          <input type="date" id="pNascimento">
          <input id="pProfissao" placeholder="Profiss√£o">
          <select id="pSexo"><option value="">Sexo...</option><option>Masculino</option><option>Feminino</option><option>Outro</option></select>
          <input id="pFrase" placeholder="Sua frase motivacional..." maxlength="80">
          <button class="btn-primary" onclick="salvarPerfilFirebase()">üíæ Salvar Altera√ß√µes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== SE√á√ÉO CONQUISTAS ==================== -->
  <div id="conquistas" class="section">
    <div class="card">
      <h3 style="cursor: default;">üèÜ Mural de Honra</h3>
      <p style="color:rgba(255, 255, 255, 0.6); font-size:14px; margin-bottom:var(--space-xl); line-height:1.6;">Desbloqueie conquistas √©picas completando desafios! Cada categoria representa um n√≠vel de dificuldade crescente.</p>
      <div id="muralConquistas">
        <div id="conquistasSkeleton">
          <div class="skeleton-category" style="margin-bottom:var(--space-xl);">
            <div class="skeleton-line" style="width:140px; height:20px; margin-bottom:var(--space-lg);"></div>
            <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:var(--space-md);">
              <div class="skeleton-badge-card"></div>
              <div class="skeleton-badge-card"></div>
              <div class="skeleton-badge-card"></div>
              <div class="skeleton-badge-card"></div>
            </div>
          </div>
          <div class="skeleton-category">
            <div class="skeleton-line" style="width:140px; height:20px; margin-bottom:var(--space-lg);"></div>
            <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:var(--space-md);">
              <div class="skeleton-badge-card"></div>
              <div class="skeleton-badge-card"></div>
              <div class="skeleton-badge-card"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ==================== SE√á√ÉO HIST√ìRICO ==================== -->
  <div id="historico" class="section">
    <div class="card">
      <h3 style="cursor: default;">üìú Hist√≥rico de Atividades</h3>
      
      <div class="historico-filtros">
        <input type="text" id="filtroPesquisa" class="filtro-input" placeholder="üîç Pesquisar atividades..." oninput="filtrarHistorico()">
        <select id="filtroTipo" class="filtro-select" onchange="filtrarHistorico()">
          <option value="">Todos os tipos</option>
          <option value="T">Tarefas</option>
          <option value="H">H√°bitos</option>
          <option value="P">Pomodoros</option>
        </select>
        <select id="filtroPeriodo" class="filtro-select" onchange="filtrarHistorico()">
          <option value="7">√öltimos 7 dias</option>
          <option value="30" selected>√öltimos 30 dias</option>
          <option value="90">√öltimos 3 meses</option>
          <option value="365">√öltimo ano</option>
          <option value="all">Todo o per√≠odo</option>
        </select>
      </div>
      
      <div class="historico-estatisticas">
        <div class="estatistica-card">
          <div class="estatistica-valor" id="totalAtividades">0</div>
          <div class="estatistica-label">Atividades</div>
        </div>
        <div class="estatistica-card">
          <div class="estatistica-valor" id="totalXP">0</div>
          <div class="estatistica-label">XP Ganhos</div>
        </div>
        <div class="estatistica-card">
          <div class="estatistica-valor" id="mediaDiaria">0</div>
          <div class="estatistica-label">M√©dia/dia</div>
        </div>
        <div class="estatistica-card">
          <div class="estatistica-valor" id="melhorDia">0</div>
          <div class="estatistica-label">Melhor dia</div>
        </div>
      </div>
      
      <div class="historico-lista" id="listHist"></div>
    </div>
  </div>

  <!-- ==================== SE√á√ÉO MODO FOCO ==================== -->
  <div id="modofoco" class="section">
    <div class="card">
      <h3 style="cursor: default;">üçÖ Modo Foco (Pomodoro)</h3>
      <p style="color:rgba(255, 255, 255, 0.6); font-size:14px; margin-bottom:var(--space-xl); line-height:1.6;">
        Aumente sua produtividade com a t√©cnica Pomodoro! Trabalhe com foco total por 25 minutos e descanse por 5.
      </p>
      
      <div class="grid-stack">
        <div class="card" style="background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(168, 85, 247, 0.1));">
          <h4 style="color: var(--accent); margin-bottom: var(--space-lg);">‚öôÔ∏è Configura√ß√µes</h4>
          <div style="margin-bottom: var(--space-md);">
            <label style="display: block; color: rgba(255, 255, 255, 0.8); margin-bottom: var(--space-sm); font-size: 14px;">Tempo de Foco (minutos):</label>
            <select id="focoTempo" style="width: 100%;">
              <option value="15">15 minutos</option>
              <option value="25" selected>25 minutos (Pomodoro Cl√°ssico)</option>
              <option value="30">30 minutos</option>
              <option value="45">45 minutos</option>
              <option value="50">50 minutos</option>
            </select>
          </div>
          
          <div style="margin-bottom: var(--space-lg);">
            <label style="display: block; color: rgba(255, 255, 255, 0.8); margin-bottom: var(--space-sm); font-size: 14px;">Tempo de Descanso (minutos):</label>
            <select id="descansoTempo" style="width: 100%;">
              <option value="5" selected>5 minutos</option>
              <option value="10">10 minutos</option>
              <option value="15">15 minutos</option>
            </select>
          </div>
          
          <button class="btn-primary" onclick="iniciarModoFoco()">üöÄ Iniciar Modo Foco</button>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));">
          <h4 style="color: var(--success); margin-bottom: var(--space-lg);">üìä Estat√≠sticas</h4>
          
          <div class="registro-group" style="margin-bottom: var(--space-lg);">
            <div class="registro-group-title">Hoje</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
              <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 800; color: var(--accent);" id="pomodorosHoje">0</div>
                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Pomodoros</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 800; color: var(--success);" id="tempoFocoHoje">0h</div>
                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Tempo Focado</div>
              </div>
            </div>
          </div>
          
          <div class="registro-group">
            <div class="registro-group-title">Total</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
              <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 800; color: var(--gold);" id="pomodorosTotal">0</div>
                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Total Pomodoros</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 800; color: var(--purple);" id="tempoFocoTotal">0h</div>
                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Tempo Total</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card" style="margin-top: var(--space-xl); background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 146, 60, 0.1));">
        <h4 style="color: var(--gold); margin-bottom: var(--space-lg);">üéØ Dicas de Produtividade</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-lg);">
          <div class="item" style="flex-direction: column; align-items: flex-start; background: rgba(255, 255, 255, 0.05);">
            <div style="font-size: 20px; margin-bottom: var(--space-sm);">1Ô∏è‚É£</div>
            <div style="font-weight: 600; margin-bottom: var(--space-xs);">Elimine Distra√ß√µes</div>
            <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">Desligue notifica√ß√µes e foque em uma tarefa por vez.</div>
          </div>
          <div class="item" style="flex-direction: column; align-items: flex-start; background: rgba(255, 255, 255, 0.05);">
            <div style="font-size: 20px; margin-bottom: var(--space-sm);">2Ô∏è‚É£</div>
            <div style="font-weight: 600; margin-bottom: var(--space-xs);">Use o Timer</div>
            <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">O temporizador cria urg√™ncia e mant√©m o foco.</div>
          </div>
          <div class="item" style="flex-direction: column; align-items: flex-start; background: rgba(255, 255, 255, 0.05);">
            <div style="font-size: 20px; margin-bottom: var(--space-sm);">3Ô∏è‚É£</div>
            <div style="font-weight: 600; margin-bottom: var(--space-xs);">Fa√ßa Pausas</div>
            <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">As pausas s√£o essenciais para manter a produtividade.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MODAIS DE REGISTRO ==================== -->
<div id="modalTarefas" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚ûï Registrar Tarefas</h3>
      <button class="modal-close" onclick="fecharModal('modalTarefas')">√ó</button>
    </div>
    
    <div class="modal-form-group">
      <label class="modal-label">NOVA CATEGORIA</label>
      <div style="display:flex; gap:var(--space-md);">
        <input id="modalCatNome" placeholder="Ex: Trabalho, Estudos...">
        <button class="btn-primary btn-plus" onclick="addCatModal()">+</button>
      </div>
    </div>
    
    <div class="modal-form-group">
      <label class="modal-label">NOVA TAREFA</label>
      <select id="modalTarCat" style="margin-bottom:var(--space-md)"></select>
      <div style="display:flex; gap:var(--space-md); margin-bottom:var(--space-sm);">
        <input id="modalTarNome" placeholder="Nome da tarefa...">
        <button class="btn-primary btn-plus" onclick="addTarModal()">+</button>
      </div>
      <textarea id="modalTarDesc" placeholder="Descri√ß√£o da tarefa (opcional)" rows="2"></textarea>
      <div style="margin-top:var(--space-sm);">
        <input id="modalSubtarNome" placeholder="Subtarefa (opcional)">
        <button class="btn-primary" style="margin-top:var(--space-sm); padding:var(--space-sm); font-size:14px;" onclick="addSubtarefaModal()">+ Adicionar Subtarefa</button>
      </div>
    </div>
    
    <div class="modal-form-group">
      <label class="modal-label">CATEGORIAS EXISTENTES</label>
      <div id="modalListCats" style="max-height:200px; overflow-y:auto; padding:var(--space-sm); background:rgba(255,255,255,0.03); border-radius:var(--radius-md);"></div>
    </div>
  </div>
</div>

<div id="modalHabitos" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚ûï Registrar H√°bitos</h3>
      <button class="modal-close" onclick="fecharModal('modalHabitos')">√ó</button>
    </div>
    
    <div class="modal-form-group">
      <label class="modal-label">NOVO H√ÅBITO</label>
      <div style="display:flex; gap:var(--space-md);">
        <input id="modalHabNome" placeholder="Ex: Meditar, Ler, Exerc√≠cios...">
        <button class="btn-primary btn-plus" onclick="addHabModal()">+</button>
      </div>
    </div>
    
    <div class="modal-form-group">
      <label class="modal-label">H√ÅBITOS EXISTENTES</label>
      <div id="modalListHabs" style="max-height:200px; overflow-y:auto; padding:var(--space-sm); background:rgba(255,255,255,0.03); border-radius:var(--radius-md);"></div>
    </div>
  </div>
</div>

<!-- ==================== OVERLAY MODO FOCO ==================== -->
<div id="focoOverlay">
  <div class="foco-container">
    <div style="font-size: 20px; color: rgba(255, 255, 255, 0.8); margin-bottom: var(--space-md);">üçÖ MODO FOCO ATIVO</div>
    <div class="foco-timer" id="focoTimer">25:00</div>
    <div style="color: rgba(255, 255, 255, 0.6); margin-bottom: var(--space-xl); font-size: 16px;" id="focoStatus">Foco - Iniciando...</div>
    
    <div class="foco-botoes">
      <button class="btn-primary" onclick="pausarModoFoco()" id="btnPausar">‚è∏Ô∏è Pausar</button>
      <button class="btn-danger-outline" onclick="pararModoFoco()">‚èπÔ∏è Parar</button>
    </div>
    
    <div style="margin-top: var(--space-xl); color: rgba(255, 255, 255, 0.5); font-size: 13px;">
      Dica: Mantenha o foco! Distra√ß√µes reduzem sua produtividade.
    </div>
  </div>
</div>

<div id="popup"></div>

<script>
// ==================== CONFIGURA√á√ÉO FIREBASE ====================
const firebaseConfig = {
  apiKey: "AIzaSyBkSJDH_aEVsp-LSNGm4XBqWoo_FUIJYNo",
  authDomain: "life-dash-e33f2.firebaseapp.com",
  projectId: "life-dash-e33f2",
  storageBucket: "life-dash-e33f2.firebasestorage.app",
  messagingSenderId: "270639106877",
  appId: "1:270639106877:web:92c8ec9353c6bacb485354"
};

// Inicializar Firebase apenas se n√£o estiver inicializado
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();
const auth = firebase.auth();

// ==================== SISTEMA DE RENDERIZA√á√ÉO OTIMIZADO ====================
let renderQueue = new Set();
let renderTimeout = null;

function scheduleRender(component = 'all') {
  renderQueue.add(component);
  
  if (renderTimeout) clearTimeout(renderTimeout);
  renderTimeout = setTimeout(() => {
    performRender();
  }, 50);
}

function performRender() {
  if (renderQueue.has('all') || renderQueue.size > 3) {
    fullRender();
  } else {
    partialRender(Array.from(renderQueue));
  }
  renderQueue.clear();
  renderTimeout = null;
}

function partialRender(components) {
  components.forEach(comp => {
    switch(comp) {
      case 'header': renderHeader(); break;
      case 'tasks': renderTasks(); break;
      case 'habits': renderHabits(); break;
      case 'structure': renderStructure(); break;
      case 'badges': renderBadges(); break;
      case 'history': renderHistory(); break;
      case 'pomodoro': renderPomodoroStats(); break;
    }
  });
}

const DOMCache = {};

function getElement(id) {
  if (!DOMCache[id]) {
    DOMCache[id] = document.getElementById(id);
  }
  return DOMCache[id];
}

// ==================== FUN√á√ïES B√ÅSICAS ====================
// Sistema XP mais dif√≠cil
function xpInfo(xp) { 
  if (typeof xp !== 'number' || xp < 0) xp = 0;
  
  let nivel = 1;
  let xpBase = 0;
  let xpProximo = 150; // Aumentado de 100 para 150
  
  while (xp >= xpProximo) {
    nivel++;
    xpBase = xpProximo;
    xpProximo += Math.floor(150 * Math.pow(1.25, nivel - 1)); // Aumentado o crescimento
  }
  
  const xpAtualNivel = xp - xpBase;
  const xpNecessarioNivel = xpProximo - xpBase;
  const porcentagem = xpNecessarioNivel > 0 ? 
    Math.min((xpAtualNivel / xpNecessarioNivel) * 100, 100) : 0;
  
  return {
    n: nivel,
    p: porcentagem,
    cur: Math.floor(xpAtualNivel),
    max: Math.floor(xpNecessarioNivel)
  };
}

function calcularIdade(d) { 
  if(!d) return "--"; 
  const h=new Date(), n=new Date(d); 
  let i=h.getFullYear()-n.getFullYear(); 
  if(h.getMonth()<n.getMonth() || (h.getMonth()===n.getMonth() && h.getDate()<n.getDate())) i--; 
  return i; 
}

// ==================== FUN√á√ïES DE UI ====================
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const menuToggle = document.querySelector('.menu-toggle');
  const menuText = document.getElementById('menu-text');
  
  sidebar.classList.toggle('open');
  menuToggle.classList.toggle('open');

  if (sidebar.classList.contains('open')) {
    menuToggle.style.position = 'fixed';
    setTimeout(() => menuText.classList.add('menu-text-active'), 100);
  } else {
    menuToggle.style.position = 'absolute';
    menuText.classList.remove('menu-text-active');
  }
}

document.addEventListener('click', function(event) {
  const sidebar = document.querySelector('.sidebar');
  const menuToggle = document.querySelector('.menu-toggle');
  const menuText = document.getElementById('menu-text');
  
  if (sidebar.classList.contains('open')) {
    if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
      sidebar.classList.remove('open');
      menuToggle.classList.remove('open');
      menuToggle.style.position = 'absolute';
      menuText.classList.remove('menu-text-active');
    }
  }
});

function irPara(id, btn) { 
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active")); 
  document.getElementById(id).classList.add("active"); 
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active")); 
  if (btn) btn.classList.add("active");
  
  if(window.innerWidth <= 1090) {
    document.querySelector('.sidebar').classList.remove('open');
    document.querySelector('.menu-toggle').classList.remove('open');
    document.querySelector('.menu-toggle').style.position = 'absolute';
    document.getElementById('menu-text').classList.remove('menu-text-active');
  }
}

function toggleAuth(m) { 
  document.getElementById('auth-login').style.display = m==='login'?'block':'none'; 
  document.getElementById('auth-register').style.display = m==='register'?'block':'none'; 
}

// ==================== TOGGLE CARD CONTENT ====================
function toggleCardContent(cardId, button) {
  const cardContent = document.getElementById(cardId);
  if (!cardContent) return;
  
  if (cardContent.classList.contains('collapsed')) {
    // Expandir
    cardContent.classList.remove('collapsed');
    cardContent.style.maxHeight = cardContent.scrollHeight + 'px';
    button.textContent = '‚ñº';
    
    setTimeout(() => {
      cardContent.style.maxHeight = 'none';
    }, 500);
  } else {
    // Colapsar
    cardContent.style.maxHeight = cardContent.scrollHeight + 'px';
    cardContent.offsetHeight; // For√ßar reflow
    cardContent.style.maxHeight = '0';
    cardContent.classList.add('collapsed');
    button.textContent = '‚ñ∂';
  }
}

// ==================== MODAIS ====================
function abrirModalTarefas() {
  document.getElementById('modalTarefas').style.display = 'flex';
  renderModalContent();
}

function abrirModalHabitos() {
  document.getElementById('modalHabitos').style.display = 'flex';
  renderModalContent();
}

function fecharModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

function renderModalContent() {
  // Atualizar select de categorias no modal
  const modalTarCat = getElement("modalTarCat");
  if (modalTarCat) {
    modalTarCat.innerHTML = S.categorias.length > 0 ? 
      S.categorias.map(c => `<option value="${c}">${c}</option>`).join("") :
      "<option value=''>Crie uma categoria primeiro</option>";
  }
  
  // Listar categorias existentes
  const modalListCats = getElement("modalListCats");
  if (modalListCats) {
    modalListCats.innerHTML = S.categorias.map((c,i) => 
      `<div class="item" style="padding:var(--space-sm) var(--space-md); margin-bottom:var(--space-xs);">
        <span>${c}</span>
        <button onclick="if(confirm('Remover categoria ${c}?')){S.categorias.splice(${i},1);salvar();renderModalContent();}" 
                style="color:var(--danger);border:none;background:none;cursor:pointer;font-size:16px">‚úñ</button>
      </div>`
    ).join("") || "<small style='color:rgba(255, 255, 255, 0.5); padding:var(--space-sm); text-align:center; display:block;'>Nenhuma categoria</small>";
  }
  
  // Listar h√°bitos existentes
  const modalListHabs = getElement("modalListHabs");
  if (modalListHabs) {
    modalListHabs.innerHTML = S.habitos.map((h,i) => 
      `<div class="item" style="padding:var(--space-sm) var(--space-md); margin-bottom:var(--space-xs);">
        <span>${h.nome} <small style="color:var(--gold); font-size:11px;">üî• ${h.streak||0}d</small></span>
        <button onclick="if(confirm('Remover h√°bito ${h.nome}?')){S.habitos.splice(${i},1);salvar();renderModalContent();}" 
                style="color:var(--danger);border:none;background:none;cursor:pointer;font-size:16px">‚úñ</button>
      </div>`
    ).join("") || "<small style='color:rgba(255, 255, 255, 0.5); padding:var(--space-sm); text-align:center; display:block;'>Nenhum h√°bito</small>";
  }
}

function addCatModal() {
  const input = getElement("modalCatNome");
  const nome = input.value.trim();
  if (nome) { 
    if (S.categorias.includes(nome)) {
      showToast("Categoria j√° existe!", 'error');
      return;
    }
    S.categorias.push(nome); 
    input.value = ""; 
    showToast("Categoria criada!", 'success');
    
    salvar();
    renderModalContent();
    scheduleRender('tasks');
  }
}

function addTarModal() {
  const nomeInput = getElement("modalTarNome");
  const catSelect = getElement("modalTarCat");
  const descInput = getElement("modalTarDesc");
  const nome = nomeInput.value.trim();
  
  if (nome && catSelect.value) { 
    const novaTarefa = {
      nome, 
      cat: catSelect.value, 
      status:'pendente',
      descricao: descInput.value.trim(),
      subtarefas: [],
      dataCriacao: new Date().toLocaleDateString(),
      ultimaAtualizacao: new Date().toLocaleDateString()
    }; 
    
    S.tarefas.push(novaTarefa); 
    nomeInput.value = ""; 
    descInput.value = "";
    showToast("Tarefa criada!", 'success');
    
    salvar();
    scheduleRender('tasks');
  } else if (!catSelect.value) {
    showToast("Crie uma categoria primeiro!", 'error');
  }
}

function addSubtarefaModal() {
  const subtarefaInput = getElement("modalSubtarNome");
  const nome = subtarefaInput.value.trim();
  
  if (nome) {
    // Esta fun√ß√£o seria chamada quando uma tarefa estiver sendo editada
    // Por enquanto, apenas limpa o campo
    subtarefaInput.value = "";
    showToast("Subtarefa ser√° adicionada √† pr√≥xima tarefa criada", 'info');
  }
}

function addHabModal() {
  const input = getElement("modalHabNome");
  const nome = input.value.trim();
  if (nome) { 
    if (S.habitos.some(h => h.nome === nome)) {
      showToast("H√°bito j√° existe!", 'error');
      return;
    }
    S.habitos.push({nome, total:0, streak:0}); 
    input.value = ""; 
    showToast("H√°bito adicionado!", 'success');
    
    salvar();
    renderModalContent();
    scheduleRender('habits');
  }
}

// Fechar modais ao clicar fora
document.querySelectorAll('.modal-overlay').forEach(modal => {
  modal.addEventListener('click', function(e) {
    if (e.target === this) {
      this.style.display = 'none';
    }
  });
});

// ==================== AUTENTICA√á√ÉO ====================
async function fazerLogin() {
  const email = document.getElementById('login-email').value.trim();
  const senha = document.getElementById('login-password').value;
  
  if (!email || !senha) {
    showToast("Preencha todos os campos", 'warning');
    return;
  }
  
  showLoading("Entrando...");
  
  try {
    await auth.signInWithEmailAndPassword(email, senha);
  } catch (error) {
    hideLoading();
    
    let mensagemErro = "Erro ao fazer login";
    
    switch(error.code) {
      case 'auth/invalid-email': mensagemErro = "Email inv√°lido"; break;
      case 'auth/user-disabled': mensagemErro = "Conta desativada"; break;
      case 'auth/user-not-found': mensagemErro = "Usu√°rio n√£o encontrado"; break;
      case 'auth/wrong-password': mensagemErro = "Senha incorreta"; break;
      case 'auth/too-many-requests': mensagemErro = "Muitas tentativas"; break;
      default: mensagemErro = error.message;
    }
    
    showToast(mensagemErro, 'error');
  }
}

async function fazerRegistro() {
  const email = document.getElementById('regEmail').value.trim();
  const senha = document.getElementById('regPassword').value;
  const nome = document.getElementById('regNome').value.trim();
  
  if (!email || !senha || !nome) {
    showToast("Nome, Email e Senha s√£o obrigat√≥rios!", 'warning');
    return;
  }
  
  if (senha.length < 6) {
    showToast("A senha deve ter no m√≠nimo 6 caracteres", 'warning');
    return;
  }
  
  showLoading("Criando sua conta...");
  
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, senha);
    
    const dadosUsuario = {
      perfil: {
        nome: nome,
        email: email,
        nascimento: document.getElementById('regNascimento').value || '',
        sexo: document.getElementById('regSexo').value || '',
        profissao: document.getElementById('regProfissao').value || '',
        frase: "Foco no progresso!",
        foto: window.tempFoto || '',
        dataCriacao: new Date().toISOString()
      },
      categorias: [],
      tarefas: [],
      habitos: [],
      hist: [],
      xp: 0,
      badges_unlocked: [],
      pomodoroStats: {
        total: 0,
        hoje: 0,
        tempoTotal: 0,
        tempoHoje: 0
      },
      ultimoReset: new Date().toLocaleDateString()
    };
    
    await db.collection("users").doc(userCredential.user.uid).set(dadosUsuario);
    
    hideLoading();
    showToast("Conta criada com sucesso! üéâ", 'success', 3000);
    
  } catch (error) {
    hideLoading();
    
    let mensagemErro = "Erro ao criar conta";
    
    switch(error.code) {
      case 'auth/email-already-in-use': mensagemErro = "Email j√° em uso"; break;
      case 'auth/invalid-email': mensagemErro = "Email inv√°lido"; break;
      case 'auth/weak-password': mensagemErro = "Senha muito fraca"; break;
      default: mensagemErro = error.message;
    }
    
    showToast(mensagemErro, 'error');
  }
}

async function recuperarSenha() {
  const email = document.getElementById('login-email').value.trim();
  
  if (!email) {
    showToast("Digite seu e-mail", 'warning');
    return;
  }
  
  showLoading("Enviando e-mail...");
  
  try {
    await auth.sendPasswordResetEmail(email);
    hideLoading();
    showToast("E-mail de recupera√ß√£o enviado!", 'success', 4000);
    
  } catch (error) {
    hideLoading();
    
    let mensagemErro = "Erro ao enviar e-mail";
    
    switch(error.code) {
      case 'auth/invalid-email': mensagemErro = "Email inv√°lido"; break;
      case 'auth/user-not-found': mensagemErro = "Usu√°rio n√£o encontrado"; break;
      default: mensagemErro = error.message;
    }
    
    showToast(mensagemErro, 'error');
  }
}

function fazerLogout() { 
  if(!confirm("Tem certeza que deseja sair?")) return;
  auth.signOut().then(() => {
    localStorage.clear();
    location.reload();
  }); 
}

// ==================== ESTADO GLOBAL ====================
let S = { 
  perfil: {}, 
  categorias: [], 
  tarefas: [], 
  habitos: [], 
  hist: [], 
  xp: 0, 
  badges_unlocked: [],
  pomodoroStats: {
    total: 0,
    hoje: 0,
    tempoTotal: 0,
    tempoHoje: 0
  },
  ultimoReset: new Date().toLocaleDateString()
};
let openCats = JSON.parse(localStorage.getItem('lifeDash_openCats')) || {};

// ==================== LISTENER DE AUTENTICA√á√ÉO ====================
auth.onAuthStateChanged(async (user) => {
  if (user) {
    document.getElementById('login-screen').style.display = 'none';
    showLoading("Carregando seus dados...");
    
    window.nivelAnterior = undefined;
    window.jaDeuBoasVindas = false;
    
    try {
      const doc = await db.collection("users").doc(user.uid).get();
      
      if (doc.exists) {
        S = doc.data();
        
        // Verificar se precisa resetar tarefas do dia anterior
        verificarResetDiario();
        
        S.perfil = S.perfil || {};
        S.badges_unlocked = S.badges_unlocked || [];
        S.hist = S.hist || [];
        S.categorias = S.categorias || [];
        S.tarefas = S.tarefas || [];
        S.habitos = S.habitos || [];
        S.xp = S.xp || 0;
        S.pomodoroStats = S.pomodoroStats || {
          total: 0,
          hoje: 0,
          tempoTotal: 0,
          tempoHoje: 0
        };
        S.ultimoReset = S.ultimoReset || new Date().toLocaleDateString();
        
        // Garantir que tarefas tenham estrutura completa
        S.tarefas = S.tarefas.map(t => ({
          ...t,
          descricao: t.descricao || '',
          subtarefas: t.subtarefas || [],
          dataCriacao: t.dataCriacao || new Date().toLocaleDateString(),
          ultimaAtualizacao: t.ultimaAtualizacao || new Date().toLocaleDateString()
        }));
  
        if (S.xp !== undefined) {
          const l = xpInfo(S.xp);
          window.nivelAnterior = l.n;
        }
  
        sincronizarInputsPerfil();
        
        setTimeout(() => {
          fullRender();

          setTimeout(() => renderHomeBadges(), 300);

          setTimeout(() => {
            hideSkeletons();
          }, 300);
          
          if (!window.jaDeuBoasVindas && S.perfil && S.perfil.nome) {
            setTimeout(() => {
              showToast(`Bem-vindo, ${S.perfil.nome}!`, 'success', 2000);
              window.jaDeuBoasVindas = true;
            }, 800);
          }
          
          setTimeout(() => {
            hideLoading();
          }, 1000);
          
        }, 100);
        
      } else {
        const novosDados = {
          perfil: {
            nome: "Novo Usu√°rio",
            email: user.email,
            frase: "Foco no progresso!",
            dataCriacao: new Date().toISOString()
          },
          categorias: [],
          tarefas: [],
          habitos: [],
          hist: [],
          xp: 0,
          badges_unlocked: [],
          pomodoroStats: {
            total: 0,
            hoje: 0,
            tempoTotal: 0,
            tempoHoje: 0
          },
          ultimoReset: new Date().toLocaleDateString()
        };
        
        await db.collection("users").doc(user.uid).set(novosDados);
        S = novosDados;
        
        fullRender();
        hideSkeletons();
        hideLoading();
        showToast("Perfil criado com sucesso!", 'success');
      }
      
    } catch (error) {
      console.error("Erro ao carregar dados:", error);
      hideLoading();
      showToast("Erro ao carregar dados. Tente recarregar.", 'error');
    }
    
  } else {
    document.getElementById('login-screen').style.display = 'flex';
    window.jaDeuBoasVindas = false;
    window.nivelAnterior = undefined;
  }
});

// ==================== VERIFICA√á√ÉO DE RESET DI√ÅRIO ====================
function verificarResetDiario() {
  const hoje = new Date().toLocaleDateString();
  
  // Se for um novo dia, resetar tarefas conclu√≠das
  if (S.ultimoReset !== hoje) {
    // Resetar estat√≠sticas de pomodoro do dia
    S.pomodoroStats.hoje = 0;
    S.pomodoroStats.tempoHoje = 0;
    
    // Marcar tarefas conclu√≠das como pendentes
    let tarefasResetadas = 0;
    S.tarefas.forEach(tarefa => {
      if (tarefa.status === 'concluido') {
        tarefa.status = 'pendente';
        tarefasResetadas++;
        
        // Resetar subtarefas
        if (tarefa.subtarefas && tarefa.subtarefas.length > 0) {
          tarefa.subtarefas.forEach(sub => {
            sub.concluida = false;
          });
        }
      }
    });
    
    // Atualizar data do √∫ltimo reset
    S.ultimoReset = hoje;
    
    // Salvar mudan√ßas se houver tarefas resetadas
    if (tarefasResetadas > 0) {
      salvar();
      showToast(`üìÖ Novo dia! ${tarefasResetadas} tarefas resetadas.`, 'info', 3000);
    }
  }
}

// ==================== FUN√á√ïES DE RENDER ====================
function renderHeader() {
  if (!S || !S.perfil) {
    return;
  }
  
  const xpAtual = S.xp || 0;
  const nivel = xpInfo(xpAtual);
  
  const hNome = document.getElementById("hNome");
  if (hNome) hNome.textContent = S.perfil.nome || "---";
  
  const hIdade = document.getElementById("hIdade");
  if (hIdade) hIdade.textContent = calcularIdade(S.perfil.nascimento);
  
  const hSexo = document.getElementById("hSexo");
  if (hSexo) hSexo.textContent = S.perfil.sexo || "---";
  
  const hProfissao = document.getElementById("hProfissao");
  if (hProfissao) hProfissao.textContent = S.perfil.profissao || "---";
  
  const hFrase = document.getElementById("hFrase");
  if (hFrase) hFrase.textContent = S.perfil.frase ? `"${S.perfil.frase}"` : `"Foco no progresso!"`;
  
  const hNivel = document.getElementById("hNivel");
  if (hNivel) hNivel.textContent = nivel.n;
  
  const xpNumerico = document.getElementById("xpNumerico");
  if (xpNumerico) xpNumerico.textContent = `${Math.floor(nivel.cur)}/${Math.floor(nivel.max)} XP`;
  
  const xpBar = document.getElementById("xpBar");
  if (xpBar) {
    xpBar.style.width = nivel.p + "%";
  }
  
  const hFoto = document.getElementById("hFoto");
  if (hFoto && S.perfil.foto) {
    hFoto.src = S.perfil.foto;
    hFoto.style.display = "block";
  }
}

function renderHomeBadges() {
  if (!S || !S.badges_unlocked || !Array.isArray(S.badges_unlocked)) {
    const erroHTML = '<small style="color:#ef4444; font-size:12px;">Erro ao carregar conquistas</small>';
    
    const homeBadges = document.getElementById("homeBadges");
    const homeBadgesMobile = document.getElementById("homeBadgesMobile");
    
    if (homeBadges) homeBadges.innerHTML = erroHTML;
    if (homeBadgesMobile) homeBadgesMobile.innerHTML = erroHTML;
    
    return;
  }
  
  const badges = S.badges_unlocked;
  let html = "";
  const ultimas5 = badges.slice(-5);
  
  if (ultimas5.length > 0) {
    ultimas5.forEach((badgeId, index) => {
      const badge = BADGES.find(b => b.id === badgeId);
      
      if (badge) {
        html += `<div class="badge-mini" title="${badge.title}: ${badge.desc}" style="animation-delay: ${index * 0.1}s;">${badge.icon}</div>`;
      } else {
        html += `<div class="badge-mini" title="Conquista desconhecida" style="border-color: rgba(255, 255, 255, 0.3);">‚ùì</div>`;
      }
    });
  } else {
    html = '<small style="color:rgba(255, 255, 255, 0.5); font-size:13px;">Nenhuma conquista ainda</small>';
  }
  
  const homeBadges = document.getElementById("homeBadges");
  const homeBadgesMobile = document.getElementById("homeBadgesMobile");
  
  if (homeBadges) {
    homeBadges.innerHTML = html;
    homeBadges.style.display = "flex";
    homeBadges.style.gap = "var(--space-sm)";
    homeBadges.style.flexWrap = "wrap";
    homeBadges.style.justifyContent = "flex-start";
  }
  
  if (homeBadgesMobile) {
    homeBadgesMobile.innerHTML = html;
    homeBadgesMobile.style.display = "flex";
    homeBadgesMobile.style.gap = "var(--space-sm)";
    homeBadgesMobile.style.flexWrap = "wrap";
    homeBadgesMobile.style.justifyContent = "flex-start";
    
    atualizarVisibilidadeBadges();
  }
}

function renderTasks() {
  let tarHtml = "";
  
  if (S.categorias.length === 0) {
    tarHtml = `
      <div class="empty-state">
        <div class="empty-state-icon">üìù</div>
        <div class="empty-state-title">Nenhuma tarefa registrada</div>
        <div class="empty-state-description">Clique no bot√£o + para criar sua primeira tarefa!</div>
      </div>`;
  } else {
    S.categorias.forEach((cat, catIndex) => {
      const ts = S.tarefas.filter(t => t.cat === cat && t.status !== 'oculta');
      const conc = ts.filter(t => t.status === 'concluido').length;
      const isOpen = openCats[cat];
      
      if (ts.length === 0) return;
      
      // Cores diferentes para cada categoria (8 cores dispon√≠veis)
      const colorIndex = catIndex % 8;
      
      tarHtml += `
        <div class="cat-header" onclick="toggleCat('${cat}')" data-color="${colorIndex}">
          <span>${cat}</span>
          <span style="font-size:12px; margin-left:auto; margin-right:var(--space-md); font-weight:600; color:${getCategoryColor(colorIndex)}">${conc}/${ts.length}</span>
          <span>${isOpen?'‚ñ≤':'‚ñº'}</span>
        </div>
        <div class="task-container-wrapper ${isOpen?'open':''}">
          ${ts.map((t, tIndex) => `
            <div class="task-item" data-task-index="${S.tarefas.indexOf(t)}">
              <div class="task-main-row">
                <div class="switch-container">
                  <label class="switch">
                    <input type="checkbox" ${t.status==='concluido'?'checked':''} onchange="toggleTarefa(${S.tarefas.indexOf(t)})">
                    <span class="slider"></span>
                  </label>
                </div>
                <span class="task-name">${t.nome}</span>
              </div>
              ${t.descricao ? `<div class="task-description" style="color:${getCategoryColor(colorIndex)}">${t.descricao}</div>` : ''}
              ${t.subtarefas && t.subtarefas.length > 0 ? `
                <div class="subtask-container">
                  ${t.subtarefas.map((sub, subIndex) => `
                    <div class="subtask-item">
                      <div class="subtask-checkbox ${sub.concluida ? 'checked' : ''}" 
                           onclick="toggleSubtarefa(${S.tarefas.indexOf(t)}, ${subIndex})"></div>
                      <span class="subtask-name">${sub.nome}</span>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          `).join("")}
        </div>`;
    });
  }
  
  setTimeout(() => {
    S.categorias.forEach((cat, index) => {
      if (openCats[cat]) {
        const wrapper = document.querySelectorAll('.task-container-wrapper')[index];
        if (wrapper && wrapper.classList.contains('open')) {
          wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
        }
      }
    });
  }, 50);
  
  const homeTarefas = getElement("homeTarefas");
  if (homeTarefas) {
    homeTarefas.innerHTML = tarHtml;
  }
}

function getCategoryColor(index) {
  const colors = [
    '#667eea', '#f093fb', '#43e97b', '#fa709a',
    '#38f9d7', '#fee140', '#a855f7', '#fb923c'
  ];
  return colors[index % colors.length];
}

function renderHabits() {
  const diasS = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
  const hoje = new Date().toLocaleDateString();
  const ultimos7 = [...Array(7)].map((_, i) => {
    const d = new Date(); 
    d.setDate(d.getDate() - (6 - i));
    return { 
      label: diasS[d.getDay()], 
      data: d.toLocaleDateString(), 
      num: d.getDate() 
    };
  });
  
  const hHead = getElement("habitHead");
  if (hHead) {
    hHead.innerHTML = `<tr><th style="text-align:left; width:35%">H√°bito</th>${ultimos7.map(d=>`<th>${d.label}<br><span style="font-size:12px">${d.num}</span></th>`).join("")}</tr>`;
  }
  
  const hBody = getElement("homeHabitos");
  if (hBody) {
    if (S.habitos.length === 0) {
      hBody.innerHTML = `<tr><td colspan="8">
        <div class="empty-state" style="padding:var(--space-xl) var(--space-lg);">
          <div class="empty-state-icon">üîÅ</div>
          <div class="empty-state-title">Nenhum h√°bito configurado</div>
          <div class="empty-state-description">Clique no bot√£o + para criar seu primeiro h√°bito!</div>
        </div>
      </td></tr>`;
    } else {
      hBody.innerHTML = S.habitos.map((h, i) => `
        <tr>
          <td style="text-align:left">
            <div class="habit-name">${h.nome}</div>
            <div style="font-size:11px; color:var(--gold); margin-top:var(--space-xs)">üî• ${h.streak||0} dias</div>
          </td>
          ${ultimos7.map(d => {
            const feito = S.hist.some(r => r.nome === h.nome && r.data === d.data);
            const isHoje = d.data === hoje;
            let cl = 'habit-circle'; 
            if (feito) cl += ' done'; 
            return `<td><div class="${cl}" ${!feito && isHoje ? `data-habit-idx="${i}" data-habit-date="${d.data}"` : ''}>${feito?'‚úì':''}</div></td>`;
          }).join("")}
        </tr>`).join("");
      
      setTimeout(() => {
        document.querySelectorAll('[data-habit-idx]').forEach(el => {
          el.addEventListener('click', function() {
            concluirHabito(parseInt(this.getAttribute('data-habit-idx')), this.getAttribute('data-habit-date'));
          });
        });
      }, 0);
    }
  }
}

function renderBadges() {
  const mConquistas = getElement("muralConquistas");
  if (!mConquistas) return;
  
  if (!S.badges_unlocked) {
    mConquistas.innerHTML = "<p style='color:rgba(255, 255, 255, 0.5); padding:var(--space-lg); text-align:center;'>Carregando conquistas...</p>";
    return;
  }
  
  const categorias = ['Iniciante', 'Intermedi√°rio', 'Avan√ßado', 'Lend√°rio'];
  let html = '';
  
  categorias.forEach(cat => {
    const badgesCat = BADGES.filter(b => b.cat === cat);
    const desbloqueadas = badgesCat.filter(b => S.badges_unlocked.includes(b.id)).length;
    const cor = BADGE_COLORS[cat];
    
    html += `
      <div class="badge-category">
        <div class="badge-category-title" style="color:${cor}">
          <span>${cat === 'Iniciante' ? 'üå±' : cat === 'Intermedi√°rio' ? '‚ö°' : cat === 'Avan√ßado' ? 'üî•' : 'üëë'}</span>
          <span>${cat}</span>
          <span style="font-size:13px; color:rgba(255, 255, 255, 0.5); font-weight:400; margin-left:auto">${desbloqueadas}/${badgesCat.length}</span>
        </div>
        <div class="badge-grid">
          ${badgesCat.map(b => {
            const ok = S.badges_unlocked.includes(b.id);
            const prog = calcularProgressoConquista(b);
            return `
              <div class="badge-card ${ok ? 'unlocked' : 'locked'}" title="${b.desc}">
                <span class="badge-icon">${b.icon}</span>
                <div class="badge-title">${b.title}</div>
                <div class="badge-desc">${b.desc}</div>
                ${!ok ? `
                  <div class="badge-progress">
                    <div style="font-size:10px; color:rgba(255, 255, 255, 0.5); margin-bottom:var(--space-xs)">${prog.atual}/${prog.total}</div>
                    <div class="badge-progress-bar">
                      <div class="badge-progress-fill" style="width:${prog.percent}%"></div>
                    </div>
                  </div>
                ` : '<div style="font-size:11px; color:var(--gold); margin-top:var(--space-sm)">‚úì Desbloqueada</div>'}
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `;
  });
  
  mConquistas.innerHTML = html;
}

function renderHistory() {
  const histEl = getElement("listHist");
  if (!histEl) return;
  
  filtrarHistorico();
}

function filtrarHistorico() {
  const pesquisa = document.getElementById('filtroPesquisa').value.toLowerCase();
  const tipo = document.getElementById('filtroTipo').value;
  const periodo = document.getElementById('filtroPeriodo').value;
  
  let historicoFiltrado = S.hist.slice().reverse();
  
  // Filtrar por tipo
  if (tipo) {
    historicoFiltrado = historicoFiltrado.filter(h => h.tipo === tipo);
  }
  
  // Filtrar por pesquisa
  if (pesquisa) {
    historicoFiltrado = historicoFiltrado.filter(h => 
      h.nome.toLowerCase().includes(pesquisa) ||
      (h.cat && h.cat.toLowerCase().includes(pesquisa))
    );
  }
  
  // Filtrar por per√≠odo
  if (periodo !== 'all') {
    const dias = parseInt(periodo);
    const dataLimite = new Date();
    dataLimite.setDate(dataLimite.getDate() - dias);
    
    historicoFiltrado = historicoFiltrado.filter(h => {
      const dataAtividade = new Date(h.data.split('/').reverse().join('-'));
      return dataAtividade >= dataLimite;
    });
  }
  
  // Renderizar hist√≥rico filtrado
  const histEl = getElement("listHist");
  if (histEl) {
    if (historicoFiltrado.length === 0) {
      histEl.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üîç</div>
          <div class="empty-state-title">Nenhuma atividade encontrada</div>
          <div class="empty-state-description">Tente ajustar os filtros de pesquisa.</div>
        </div>`;
    } else {
      histEl.innerHTML = historicoFiltrado.map(h => {
        const tipoClasse = h.tipo === 'T' ? 'tarefa' : h.tipo === 'H' ? 'habito' : 'pomodoro';
        const tipoIcon = h.tipo === 'T' ? 'üìã' : h.tipo === 'H' ? 'üîÅ' : 'üçÖ';
        return `
          <div class="historico-item">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:var(--space-xs);">
              <div style="display:flex; align-items:center; gap:var(--space-sm);">
                <span class="historico-tipo historico-tipo-${tipoClasse}">${tipoIcon} ${h.tipo === 'T' ? 'Tarefa' : h.tipo === 'H' ? 'H√°bito' : 'Pomodoro'}</span>
                <strong style="font-size:14px;">${h.nome}</strong>
              </div>
              <span style="color:var(--accent);font-weight:600">+${h.xpGanhos}XP</span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:12px; color:rgba(255, 255, 255, 0.6);">
              <span>${h.data} ${h.hora ? `‚Ä¢ ${h.hora}:00` : ''}</span>
              ${h.cat ? `<span style="color:var(--purple);">${h.cat}</span>` : ''}
            </div>
          </div>
        `;
      }).join("");
    }
  }
  
  // Atualizar estat√≠sticas
  atualizarEstatisticasHistorico(historicoFiltrado);
}

function atualizarEstatisticasHistorico(historico) {
  // Total de atividades
  document.getElementById('totalAtividades').textContent = historico.length;
  
  // Total de XP
  const totalXP = historico.reduce((sum, h) => sum + (h.xpGanhos || 0), 0);
  document.getElementById('totalXP').textContent = totalXP;
  
  // M√©dia di√°ria (√∫ltimos 30 dias)
  const hoje = new Date();
  const trintaDiasAtras = new Date();
  trintaDiasAtras.setDate(hoje.getDate() - 30);
  
  const atividades30Dias = historico.filter(h => {
    const dataAtividade = new Date(h.data.split('/').reverse().join('-'));
    return dataAtividade >= trintaDiasAtras;
  });
  
  const diasComAtividades = new Set(atividades30Dias.map(h => h.data)).size;
  const mediaDiaria = diasComAtividades > 0 ? (atividades30Dias.length / diasComAtividades).toFixed(1) : 0;
  document.getElementById('mediaDiaria').textContent = mediaDiaria;
  
  // Melhor dia (dia com mais XP)
  const xpPorDia = {};
  historico.forEach(h => {
    xpPorDia[h.data] = (xpPorDia[h.data] || 0) + (h.xpGanhos || 0);
  });
  
  let melhorDiaXP = 0;
  for (const dia in xpPorDia) {
    if (xpPorDia[dia] > melhorDiaXP) {
      melhorDiaXP = xpPorDia[dia];
    }
  }
  document.getElementById('melhorDia').textContent = melhorDiaXP;
}

function renderPomodoroStats() {
  const pomodorosHoje = document.getElementById('pomodorosHoje');
  const tempoFocoHoje = document.getElementById('tempoFocoHoje');
  const pomodorosTotal = document.getElementById('pomodorosTotal');
  const tempoFocoTotal = document.getElementById('tempoFocoTotal');
  
  if (pomodorosHoje) pomodorosHoje.textContent = S.pomodoroStats?.hoje || 0;
  if (tempoFocoHoje) tempoFocoHoje.textContent = formatarTempo((S.pomodoroStats?.tempoHoje || 0) * 60);
  if (pomodorosTotal) pomodorosTotal.textContent = S.pomodoroStats?.total || 0;
  if (tempoFocoTotal) tempoFocoTotal.textContent = formatarTempo((S.pomodoroStats?.tempoTotal || 0) * 60);
}

function fullRender() {
  if (!S || !S.perfil || Object.keys(S.perfil).length === 0) {
    return;
  }
  
  renderHeader();
  renderTasks();
  renderHabits();
  renderBadges();
  renderHistory();
  renderPomodoroStats();
}

function render() {
  scheduleRender('all');
}

// ==================== MODO FOCO (POMODORO) ====================
let focoTimer = null;
let tempoRestante = 25 * 60;
let isPomodoro = true;
let isRunning = false;
let pomodoroCount = 0;

function iniciarModoFoco() {
  const tempoFoco = parseInt(document.getElementById('focoTempo').value) * 60;
  tempoRestante = tempoFoco;
  isPomodoro = true;
  isRunning = true;
  
  document.getElementById('focoOverlay').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  
  atualizarDisplayTimer();
  
  focoTimer = setInterval(() => {
    if (isRunning) {
      tempoRestante--;
      atualizarDisplayTimer();
      
      if (tempoRestante <= 0) {
        clearInterval(focoTimer);
        if (isPomodoro) {
          // Pomodoro completado
          pomodoroCount++;
          S.pomodoroStats.hoje = (S.pomodoroStats.hoje || 0) + 1;
          S.pomodoroStats.total = (S.pomodoroStats.total || 0) + 1;
          S.pomodoroStats.tempoHoje = (S.pomodoroStats.tempoHoje || 0) + parseInt(document.getElementById('focoTempo').value);
          S.pomodoroStats.tempoTotal = (S.pomodoroStats.tempoTotal || 0) + parseInt(document.getElementById('focoTempo').value);
          
          // Ganhar XP por pomodoro completado (reduzido)
          S.xp += 15; // Reduzido de 25 para 15
          S.hist.push({
            nome: "Pomodoro Completado",
            data: new Date().toLocaleDateString(),
            tipo: 'P',
            xpGanhos: 15
          });
          
          salvar();
          showToast(`üçÖ Pomodoro completo! +15 XP`, 'success');
          
          // Iniciar descanso
          const tempoDescanso = parseInt(document.getElementById('descansoTempo').value) * 60;
          tempoRestante = tempoDescanso;
          isPomodoro = false;
          isRunning = true;
          
          document.getElementById('focoStatus').textContent = "Descanso - Relaxe!";
          
          focoTimer = setInterval(() => {
            if (isRunning) {
              tempoRestante--;
              atualizarDisplayTimer();
              
              if (tempoRestante <= 0) {
                clearInterval(focoTimer);
                showToast("‚è∞ Descanso terminado! Hora de focar novamente.", 'info');
                document.getElementById('focoStatus').textContent = "Pronto para come√ßar...";
              }
            }
          }, 1000);
        }
      }
    }
  }, 1000);
}

function pausarModoFoco() {
  isRunning = !isRunning;
  const btnPausar = document.getElementById('btnPausar');
  if (btnPausar) {
    btnPausar.innerHTML = isRunning ? '‚è∏Ô∏è Pausar' : '‚ñ∂Ô∏è Continuar';
  }
}

function pararModoFoco() {
  clearInterval(focoTimer);
  document.getElementById('focoOverlay').style.display = 'none';
  document.body.style.overflow = 'auto';
  showToast("Modo foco encerrado", 'info');
  
  // Atualizar estat√≠sticas
  renderPomodoroStats();
}

function atualizarDisplayTimer() {
  const minutos = Math.floor(tempoRestante / 60);
  const segundos = tempoRestante % 60;
  const timerDisplay = document.getElementById('focoTimer');
  const statusDisplay = document.getElementById('focoStatus');
  
  if (timerDisplay) {
    timerDisplay.textContent = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
  }
  
  if (statusDisplay) {
    statusDisplay.textContent = isPomodoro ? 
      `Foco - ${pomodoroCount + 1}¬∫ Pomodoro` : 
      "Descanso - Relaxe!";
  }
}

function formatarTempo(segundos) {
  const horas = Math.floor(segundos / 3600);
  const minutos = Math.floor((segundos % 3600) / 60);
  
  if (horas > 0) {
    return `${horas}h ${minutos}m`;
  } else {
    return `${minutos}m`;
  }
}

// ==================== GESTOS TOUCH PARA MOBILE ====================
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', e => {
  touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', e => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe();
});

function handleSwipe() {
  const sections = ['home', 'conquistas', 'perfil', 'historico', 'modofoco'];
  const currentSection = document.querySelector('.section.active');
  if (!currentSection) return;
  
  const currentIndex = sections.indexOf(currentSection.id);
  if (currentIndex === -1) return;
  
  const swipeThreshold = 50;
  
  if (touchEndX < touchStartX - swipeThreshold && currentIndex < sections.length - 1) {
    // Swipe left - pr√≥xima se√ß√£o
    const nextBtn = document.querySelector(`.nav button[onclick*="${sections[currentIndex + 1]}"]`);
    if (nextBtn) {
      irPara(sections[currentIndex + 1], nextBtn);
    }
  } else if (touchEndX > touchStartX + swipeThreshold && currentIndex > 0) {
    // Swipe right - se√ß√£o anterior
    const prevBtn = document.querySelector(`.nav button[onclick*="${sections[currentIndex - 1]}"]`);
    if (prevBtn) {
      irPara(sections[currentIndex - 1], prevBtn);
    }
  }
}

// ==================== OUTRAS FUN√á√ïES ====================
function sincronizarInputsPerfil() {
  document.getElementById("pNome").value = S.perfil.nome || "";
  document.getElementById("pNascimento").value = S.perfil.nascimento || "";
  document.getElementById("pProfissao").value = S.perfil.profissao || "";
  document.getElementById("pSexo").value = S.perfil.sexo || "";
  document.getElementById("pFrase").value = S.perfil.frase || "";
  if(S.perfil.foto) { 
    const img = document.getElementById("pPreview"); 
    img.src = S.perfil.foto; 
    img.style.display="block"; 
    document.getElementById("pCameraIcon").style.opacity="0"; 
  }
}

function salvarPerfilFirebase() {
  S.perfil.nome = document.getElementById("pNome").value.trim();
  S.perfil.nascimento = document.getElementById("pNascimento").value;
  S.perfil.profissao = document.getElementById("pProfissao").value.trim();
  S.perfil.sexo = document.getElementById("pSexo").value;
  S.perfil.frase = document.getElementById("pFrase").value.trim();
  if(window.tempFoto) S.perfil.foto = window.tempFoto;
  salvar(); 
  showToast("Perfil atualizado com sucesso!", 'success');
}

function toggleTarefa(idx) {
  const t = S.tarefas[idx]; 
  const hoje = new Date().toLocaleDateString();

  if (t.status === 'pendente') {
    t.status = 'concluido'; 
    // XP reduzido de 10 para 5
    S.xp = (S.xp || 0) + 5;
    S.hist.push({
      nome: t.nome, 
      data: hoje, 
      tipo: 'T', 
      cat: t.cat, 
      xpGanhos: 5, // Reduzido
      hora: new Date().getHours()
    });
    
    showToast("+5 XP ‚úì", 'success');
    scheduleRender('header');
    scheduleRender('tasks');
    scheduleRender('history');
    checarConquistas();
  } else {
    t.status = 'pendente'; 
    S.xp = Math.max(0, (S.xp || 0) - 5);
    const hIdx = S.hist.findLastIndex(h => h.nome === t.nome && h.data === hoje);
    if (hIdx > -1) S.hist.splice(hIdx, 1);
    
    showToast("-5 XP", 'error');
    scheduleRender('header');
    scheduleRender('tasks');
    scheduleRender('history');
    checarConquistas();
  }

  salvar();
}

function toggleSubtarefa(tarefaIndex, subtarefaIndex) {
  const tarefa = S.tarefas[tarefaIndex];
  if (!tarefa || !tarefa.subtarefas || !tarefa.subtarefas[subtarefaIndex]) return;
  
  const subtarefa = tarefa.subtarefas[subtarefaIndex];
  subtarefa.concluida = !subtarefa.concluida;
  
  // Pequena quantidade de XP por subtarefa
  if (subtarefa.concluida) {
    S.xp += 2;
    S.hist.push({
      nome: `Subtarefa: ${subtarefa.nome}`,
      data: new Date().toLocaleDateString(),
      tipo: 'T',
      cat: tarefa.cat,
      xpGanhos: 2,
      hora: new Date().getHours()
    });
    showToast("+2 XP (subtarefa)", 'success');
  } else {
    S.xp = Math.max(0, (S.xp || 0) - 2);
    const hIdx = S.hist.findLastIndex(h => h.nome === `Subtarefa: ${subtarefa.nome}`);
    if (hIdx > -1) S.hist.splice(hIdx, 1);
    showToast("-2 XP (subtarefa)", 'error');
  }
  
  scheduleRender('header');
  scheduleRender('tasks');
  scheduleRender('history');
  checarConquistas();
  salvar();
}

function concluirHabito(habIdx, dataStr) {
  const h = S.habitos[habIdx];
  const hojeStr = new Date().toLocaleDateString();
  
  if (S.hist.some(r => r.nome === h.nome && r.data === dataStr)) return;
  
  h.total = (h.total || 0) + 1;
  h.ultimaConclusao = dataStr;
  
  if (dataStr === hojeStr) {
    h.streak = (h.streak || 0) + 1;
  }

  // XP reduzido de 15 para 8
  S.xp += 8;
  S.hist.push({
    nome: h.nome, 
    data: dataStr, 
    tipo: 'H', 
    xpGanhos: 8, // Reduzido
    hora: new Date().getHours()
  });

  showToast("+8 XP! üî•", 'success');
  
  scheduleRender('header');
  scheduleRender('habits');
  scheduleRender('history');
  checarConquistas();
  
  salvar();
}

function toggleCat(cat) {
  openCats[cat] = !openCats[cat];
  localStorage.setItem('lifeDash_openCats', JSON.stringify(openCats));
  
  const catIndex = S.categorias.indexOf(cat);
  const wrappers = document.querySelectorAll('.task-container-wrapper');
  const headers = document.querySelectorAll('.cat-header');
  
  const currentWrapper = wrappers[catIndex];
  const currentHeader = headers[catIndex];
  
  if (!currentWrapper) return;
  
  // Atualizar √≠cone
  const iconSpan = currentHeader.querySelector('span:last-child');
  if (iconSpan) {
    iconSpan.innerText = openCats[cat] ? '‚ñ≤' : '‚ñº';
  }
  
  // Anima√ß√£o suave
  if (openCats[cat]) {
    currentWrapper.classList.add('open');
    currentWrapper.style.maxHeight = currentWrapper.scrollHeight + 'px';
  } else {
    currentWrapper.style.maxHeight = currentWrapper.scrollHeight + 'px';
    currentWrapper.offsetHeight; // For√ßar reflow
    currentWrapper.style.maxHeight = '0';
    currentWrapper.classList.remove('open');
  }
}

// ==================== CONQUISTAS ====================
const BADGES = [
  {id:'1', icon:'üëã', title:'Primeiro Passo', desc:'Crie sua primeira tarefa', cat:'Iniciante', req:(s)=> s.tarefas.length >= 1},
  {id:'2', icon:'üå±', title:'Plantando H√°bitos', desc:'Adicione seu primeiro h√°bito', cat:'Iniciante', req:(s)=> s.habitos.length >= 1},
  {id:'3', icon:'‚úÖ', title:'Primeira Vit√≥ria', desc:'Complete sua primeira tarefa', cat:'Iniciante', req:(s)=> s.hist.filter(h=>h.tipo==='T').length >= 1},
  {id:'4', icon:'üéØ', title:'Focado', desc:'Complete 5 tarefas', cat:'Iniciante', req:(s)=> s.hist.filter(h=>h.tipo==='T').length >= 5},
  {id:'5', icon:'üöÄ', title:'Decolagem', desc:'Alcance o n√≠vel 2', cat:'Intermedi√°rio', req:(s)=> xpInfo(s.xp).n >= 2},
  {id:'6', icon:'üí™', title:'Determinado', desc:'Complete 20 tarefas', cat:'Intermedi√°rio', req:(s)=> s.hist.filter(h=>h.tipo==='T').length >= 20},
  {id:'7', icon:'üî•', title:'Em Chamas', desc:'Mantenha 3 dias de sequ√™ncia em um h√°bito', cat:'Intermedi√°rio', req:(s)=> s.habitos.some(h=>h.streak >= 3)},
  {id:'8', icon:'üìö', title:'Organizado', desc:'Crie 3 categorias diferentes', cat:'Intermedi√°rio', req:(s)=> s.categorias.length >= 3},
  {id:'9', icon:'‚è∞', title:'Pontual', desc:'Complete 10 h√°bitos', cat:'Intermedi√°rio', req:(s)=> s.hist.filter(h=>h.tipo==='H').length >= 10},
  {id:'10', icon:'ü¶â', title:'Coruja', desc:'Complete 5 tarefas ap√≥s √†s 20h', cat:'Intermedi√°rio', req:(s)=> s.hist.filter(h=>h.tipo==='T' && parseInt(h.hora)>=20).length >= 5},
  {id:'11', icon:'üèÉ', title:'Maratonista', desc:'Complete 50 tarefas', cat:'Avan√ßado', req:(s)=> s.hist.filter(h=>h.tipo==='T').length >= 50},
  {id:'12', icon:'üåü', title:'Estrela Cadente', desc:'Alcance o n√≠vel 5', cat:'Avan√ßado', req:(s)=> xpInfo(s.xp).n >= 5},
  {id:'13', icon:'üíé', title:'Consistente', desc:'7 dias de sequ√™ncia em um h√°bito', cat:'Avan√ßado', req:(s)=> s.habitos.some(h=>h.streak >= 7)},
  {id:'14', icon:'üé®', title:'Multitarefa', desc:'Tenha 5 h√°bitos ativos', cat:'Avan√ßado', req:(s)=> s.habitos.length >= 5},
  {id:'15', icon:'üìà', title:'Produtivo', desc:'Acumule 500 XP', cat:'Avan√ßado', req:(s)=> s.xp >= 500},
  {id:'16', icon:'üß†', title:'Estrategista', desc:'Complete todas as tarefas de uma categoria', cat:'Avan√ßado', req:(s)=> s.categorias.some(cat => {
    const tarefas = s.tarefas.filter(t => t.cat === cat);
    return tarefas.length > 0 && tarefas.every(t => t.status === 'concluido');
  })},
  {id:'17', icon:'üëë', title:'Lenda', desc:'Alcance o n√≠vel 10', cat:'Lend√°rio', req:(s)=> xpInfo(s.xp).n >= 10},
  {id:'18', icon:'üî±', title:'Impar√°vel', desc:'Complete 100 tarefas', cat:'Lend√°rio', req:(s)=> s.hist.filter(h=>h.tipo==='T').length >= 100},
  {id:'19', icon:'‚ö°', title:'Super-Humano', desc:'30 dias de sequ√™ncia em um h√°bito', cat:'Lend√°rio', req:(s)=> s.habitos.some(h=>h.streak >= 30)},
  {id:'20', icon:'üèÜ', title:'Mestre da Produtividade', desc:'1000 XP acumulados', cat:'Lend√°rio', req:(s)=> s.xp >= 1000},
  {id:'21', icon:'üí´', title:'Perfei√ß√£o', desc:'Complete 50 h√°bitos', cat:'Lend√°rio', req:(s)=> s.hist.filter(h=>h.tipo==='H').length >= 50},
  {id:'22', icon:'üåà', title:'Arco-√çris', desc:'Desbloqueie 15 conquistas', cat:'Lend√°rio', req:(s)=> s.badges_unlocked.length >= 15},
  {id:'23', icon:'üçÖ', title:'Pomodoro Master', desc:'Complete 10 pomodoros', cat:'Intermedi√°rio', req:(s)=> s.pomodoroStats?.total >= 10},
  {id:'24', icon:'‚è≥', title:'Foco Total', desc:'Acumule 10 horas em modo foco', cat:'Avan√ßado', req:(s)=> (s.pomodoroStats?.tempoTotal || 0) >= 600}
];

const BADGE_COLORS = {
  'Iniciante': '#22c55e',
  'Intermedi√°rio': '#38bdf8',
  'Avan√ßado': '#a855f7',
  'Lend√°rio': '#f59e0b'
};

function calcularProgressoConquista(badge) {
  let atual = 0;
  let total = 0;
  
  if(badge.id === '1') { atual = S.tarefas.length; total = 1; }
  else if(badge.id === '2') { atual = S.habitos.length; total = 1; }
  else if(badge.id === '3') { atual = S.hist.filter(h=>h.tipo==='T').length; total = 1; }
  else if(badge.id === '4') { atual = S.hist.filter(h=>h.tipo==='T').length; total = 5; }
  else if(badge.id === '5') { atual = xpInfo(S.xp).n; total = 2; }
  else if(badge.id === '6') { atual = S.hist.filter(h=>h.tipo==='T').length; total = 20; }
  else if(badge.id === '7') { atual = Math.max(...S.habitos.map(h=>h.streak||0), 0); total = 3; }
  else if(badge.id === '8') { atual = S.categorias.length; total = 3; }
  else if(badge.id === '9') { atual = S.hist.filter(h=>h.tipo==='H').length; total = 10; }
  else if(badge.id === '10') { atual = S.hist.filter(h=>h.tipo==='T' && parseInt(h.hora)>=20).length; total = 5; }
  else if(badge.id === '11') { atual = S.hist.filter(h=>h.tipo==='T').length; total = 50; }
  else if(badge.id === '12') { atual = xpInfo(S.xp).n; total = 5; }
  else if(badge.id === '13') { atual = Math.max(...S.habitos.map(h=>h.streak||0), 0); total = 7; }
  else if(badge.id === '14') { atual = S.habitos.length; total = 5; }
  else if(badge.id === '15') { atual = S.xp; total = 500; }
  else if(badge.id === '17') { atual = xpInfo(S.xp).n; total = 10; }
  else if(badge.id === '18') { atual = S.hist.filter(h=>h.tipo==='T').length; total = 100; }
  else if(badge.id === '19') { atual = Math.max(...S.habitos.map(h=>h.streak||0), 0); total = 30; }
  else if(badge.id === '20') { atual = S.xp; total = 1000; }
  else if(badge.id === '21') { atual = S.hist.filter(h=>h.tipo==='H').length; total = 50; }
  else if(badge.id === '22') { atual = S.badges_unlocked.length; total = 15; }
  else if(badge.id === '23') { atual = S.pomodoroStats?.total || 0; total = 10; }
  else if(badge.id === '24') { atual = S.pomodoroStats?.tempoTotal || 0; total = 600; }
  
  return { 
    atual: Math.min(atual, total), 
    total, 
    percent: total > 0 ? Math.min((atual / total) * 100, 100) : 0 
  };
}

function checarConquistas() {
  let novasConquistas = false;
  BADGES.forEach(b => {
    if(!S.badges_unlocked.includes(b.id) && b.req(S)) {
      S.badges_unlocked.push(b.id);
      novasConquistas = true;
      setTimeout(() => {
        mostrarAnimacaoConquista(b);
      }, 300);
    }
  });
  if(novasConquistas) {
    salvar();
    scheduleRender('badges');
    scheduleRender('header');
  }
}

// ==================== FUN√á√ïES DE UX ====================
function showLoading(message = "Carregando...") {
  let overlay = document.getElementById('loadingOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'loadingOverlay';
    overlay.className = 'loading-overlay';
    overlay.innerHTML = `
      <div class="loading-content">
        <div class="spinner" style="width:48px; height:48px; margin-bottom:var(--space-lg);"></div>
        <div style="color:var(--accent); font-size:20px; font-weight:600;">${message}</div>
        <div style="color:rgba(255, 255, 255, 0.6); font-size:15px; margin-top:var(--space-sm);">Aguarde um momento...</div>
      </div>
    `;
    document.body.appendChild(overlay);
  }
  setTimeout(() => overlay.classList.add('active'), 10);
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.remove('active');
    setTimeout(() => {
      if (overlay.parentNode && !overlay.classList.contains('active')) {
        overlay.remove();
      }
    }, 300);
  }
}

function showToast(message, type = 'info', duration = 3000) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `
    <span class="toast-icon">${icons[type] || icons.info}</span>
    <span style="flex:1; font-size:15px;">${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => toast.classList.add('show'), 10);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (toast.parentNode) toast.remove();
    }, 400);
  }, duration);
}

function hideSkeletons() {
  const fotoSkeleton = document.getElementById("hFotoSkeleton");
  const foto = document.getElementById("hFoto");
  if (fotoSkeleton) fotoSkeleton.style.display = "none";
  if (foto) foto.style.display = "block";
  
  const profileInfoSkeleton = document.getElementById("profileInfoSkeleton");
  const profileInfoReal = document.getElementById("profileInfoReal");
  if (profileInfoSkeleton) profileInfoSkeleton.style.display = "none";
  if (profileInfoReal) profileInfoReal.style.display = "block";
  
  const mobileBadgesSkeleton = document.getElementById("mobileBadgesSkeleton");
  const mobileBadgesReal = document.getElementById("mobileBadgesReal");
  if (mobileBadgesSkeleton) mobileBadgesSkeleton.style.display = "none";
  if (mobileBadgesReal) {
    mobileBadgesReal.style.display = "block";
    setTimeout(atualizarVisibilidadeBadges, 50);
  }
  
  const xpInfoSkeleton = document.getElementById("xpInfoSkeleton");
  const xpInfoReal = document.getElementById("xpInfoReal");
  if (xpInfoSkeleton) xpInfoSkeleton.style.display = "none";
  if (xpInfoReal) xpInfoReal.style.display = "block";
  
  const badgesSkeleton = document.getElementById("badgesSkeleton");
  const homeBadges = document.getElementById("homeBadges");
  const conquistasTitulo = document.getElementById("conquistasTitulo");
  if (badgesSkeleton) badgesSkeleton.style.display = "none";
  if (homeBadges) homeBadges.style.display = "flex";
  if (conquistasTitulo) conquistasTitulo.style.display = "block";
  
  document.querySelectorAll('.skeleton-line').forEach(el => {
    el.style.display = 'none';
  });

  const tarefasSkeleton = document.getElementById("tarefasSkeleton");
  const homeTarefas = document.getElementById("homeTarefas");
  if (tarefasSkeleton) tarefasSkeleton.style.display = "none";
  if (homeTarefas) homeTarefas.style.display = "block";
  
  const habitosSkeleton = document.getElementById("habitosSkeleton");
  const habitTable = document.querySelector(".habit-table");
  if (habitosSkeleton) habitosSkeleton.style.display = "none";
  if (habitTable) habitTable.style.display = "table";
}

// ==================== FUN√á√ïES DE FOTO ====================
function previewRegistro(input) { 
  if(input.files && input.files[0]){ 
    const r = new FileReader(); 
    r.onload = (e) => { 
      window.tempFoto = e.target.result; 
      document.getElementById("regPreview").src = window.tempFoto; 
      document.getElementById("regPreview").style.display="block"; 
    }; 
    r.readAsDataURL(input.files[0]); 
  } 
}

function localPreview(input) { 
  if(input.files && input.files[0]){ 
    const r = new FileReader(); 
    r.onload = (e) => { 
      window.tempFoto = e.target.result; 
      document.getElementById("pPreview").src = window.tempFoto; 
      document.getElementById("pPreview").style.display="block"; 
      document.getElementById("pCameraIcon").style.opacity="0"; 
    }; 
    r.readAsDataURL(input.files[0]); 
  } 
}

// ==================== SISTEMA DE SALVAMENTO ====================
let saveTimeout;
function salvar() { 
  if (saveTimeout) clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => {
    if(auth.currentUser) {
      db.collection("users").doc(auth.currentUser.uid).set(S, { merge: true }).catch(err => {
        console.error("Erro ao salvar:", err);
        showToast("Erro ao salvar dados", 'error');
      });
    }
  }, 1000);
}

function resetDia() {
  if(!confirm("Deseja realmente resetar TODO o progresso de hoje?")) return;
  
  const hoje = new Date().toLocaleDateString();
  const atividadesDeHoje = S.hist.filter(x => x.data === hoje);
  let xpParaRemover = 0;
  
  atividadesDeHoje.forEach(atv => {
    xpParaRemover += (atv.xpGanhos || 0);
    if(atv.tipo === 'H') {
      const hab = S.habitos.find(h => h.nome === atv.nome);
      if(hab && hab.streak > 0) hab.streak -= 1;
    }
  });

  S.xp = Math.max(0, S.xp - xpParaRemover);
  S.hist = S.hist.filter(x => x.data !== hoje);
  S.tarefas.forEach(t => t.status = 'pendente');
  
  // Resetar subtarefas
  S.tarefas.forEach(t => {
    if (t.subtarefas && t.subtarefas.length > 0) {
      t.subtarefas.forEach(sub => {
        sub.concluida = false;
      });
    }
  });
  
  const conquistasAntes = [...S.badges_unlocked];
  S.badges_unlocked = S.badges_unlocked.filter(id => {
    const b = BADGES.find(badge => badge.id === id);
    return b ? b.req(S) : false;
  });
  
  salvar();
  showToast("Progresso de hoje resetado!", 'success');
  fullRender();
}

function resetGeral() {
  if(!confirm("‚ö†Ô∏è ATEN√á√ÉO! Isso apagar√° PERMANENTEMENTE todos os dados exceto seu perfil.")) return;
  if(!confirm("√öLTIMA CONFIRMA√á√ÉO: Esta a√ß√£o √© IRREVERS√çVEL!")) return;
  
  S = { 
    perfil: S.perfil, 
    categorias: [], 
    tarefas: [], 
    habitos: [], 
    hist: [], 
    xp: 0, 
    badges_unlocked: [],
    pomodoroStats: {
      total: 0,
      hoje: 0,
      tempoTotal: 0,
      tempoHoje: 0
    },
    ultimoReset: new Date().toLocaleDateString()
  }; 
  
  localStorage.removeItem('lifeDash_openCats');
  openCats = {};
  window.nivelAnterior = 1;

  if(auth.currentUser) {
    db.collection("users").doc(auth.currentUser.uid).set(S).then(() => {
      showToast("Sistema resetado com sucesso!", 'success');
      fullRender();
    });
  }
}

// ==================== ANIMA√á√ïES ====================
function mostrarAnimacaoLevelUp(nivel) {
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.95);
    backdrop-filter: blur(20px);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  `;
  
  overlay.innerHTML = `
    <div style="text-align: center; animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
      <div style="font-size: 120px; margin-bottom: var(--space-lg); animation: rotate 1s ease;">‚≠ê</div>
      <h1 style="color: var(--gold); font-size: 56px; margin: 0; text-shadow: 0 0 30px var(--gold); font-weight:800">LEVEL UP!</h1>
      <p style="color: white; font-size: 36px; margin: var(--space-md) 0; font-weight:600">N√≠vel ${nivel}</p>
      <p style="color: var(--accent); font-size: 20px;">Voc√™ est√° evoluindo! Continue assim! üöÄ</p>
    </div>
  `;
  
  document.body.appendChild(overlay);
  setTimeout(() => {
    overlay.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => overlay.remove(), 300);
  }, 3000);
}

function mostrarAnimacaoConquista(badge) {
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.95);
    backdrop-filter: blur(20px);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  `;
  
  const cor = BADGE_COLORS[badge.cat] || 'var(--gold)';
  
  overlay.innerHTML = `
    <div style="text-align: center; animation: bounceIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); max-width:500px; padding:var(--space-lg)">
      <div style="font-size: 120px; margin-bottom: var(--space-lg); animation: pulse 1s infinite;">${badge.icon}</div>
      <h2 style="color: ${cor}; font-size: 42px; margin: 0; text-shadow: 0 0 20px ${cor}; font-weight:800">üèÜ CONQUISTA!</h2>
      <p style="color: white; font-size: 32px; margin: var(--space-lg) 0; font-weight: 700;">${badge.title}</p>
      <p style="color: var(--accent); font-size: 18px; line-height:1.6">${badge.desc}</p>
    </div>
  `;
  
  document.body.appendChild(overlay);
  setTimeout(() => {
    overlay.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => overlay.remove(), 300);
  }, 4000);
}

// ==================== CONTROLE DE RESPONSIVIDADE ====================
function atualizarVisibilidadeBadges() {
  const isMobile = window.innerWidth <= 1090;
  
  const homeBadgesMobile = document.getElementById("homeBadgesMobile");
  const conquistasDesktop = document.querySelector('.card-slim:nth-child(2)');
  
  if (isMobile) {
    if (homeBadgesMobile) {
      homeBadgesMobile.style.display = "flex";
    }
    if (conquistasDesktop) {
      conquistasDesktop.style.display = "none";
    }
  } else {
    if (homeBadgesMobile) {
      homeBadgesMobile.style.display = "none";
    }
    if (conquistasDesktop) {
      conquistasDesktop.style.display = "flex";
    }
  }
}

window.addEventListener('resize', atualizarVisibilidadeBadges);

// ==================== INICIALIZA√á√ÉO ====================
function inicializarApp() {
  const ids = [
    'hNome', 'hIdade', 'hSexo', 'hProfissao', 'hFrase',
    'hNivel', 'xpBar', 'xpNumerico', 'hFoto',
    'homeBadges', 'homeBadgesMobile',
    'homeTarefas', 'habitHead', 'homeHabitos',
    'muralConquistas', 'listHist'
  ];
  
  ids.forEach(id => {
    DOMCache[id] = document.getElementById(id);
  });
  
  window.jaDeuBoasVindas = false;
  window.nivelAnterior = undefined;
  window.tempFoto = "";
  
  if (!auth.currentUser) {
    document.getElementById('login-screen').style.display = 'flex';
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', inicializarApp);
} else {
  inicializarApp();
}

// Remover Service Worker para evitar erros
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(function(registrations) {
    for(let registration of registrations) {
      registration.unregister();
    }
  });
}
</script>
</body>
</html>
