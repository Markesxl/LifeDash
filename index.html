<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Life Dash - Intelligence Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg-sidebar: #020617; --bg-main: #0b1120;
  --card-bg: #161e2d; --accent: #38bdf8; --text: #e5e7eb;
  --gold: #f59e0b; --danger: #ef4444; --success: #22c55e;
}
*{box-sizing:border-box; font-family: 'Segoe UI', sans-serif;}
body{margin:0; background: var(--bg-main); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden;}

/* MENU HAMB√öRGUER (Item 3) */
.menu-toggle {
    display: none; position: fixed; top: 15px; left: 15px; z-index: 1100;
    background: var(--bg-sidebar); border: 1px solid var(--accent);
    color: var(--accent); padding: 8px 12px; border-radius: 5px; cursor: pointer;
}

/* SIDEBAR */
.sidebar { 
    width: 240px; background: var(--bg-sidebar); padding: 20px; border-right: 1px solid #1e293b; 
    position: fixed; height: 100vh; z-index: 1000; transition: transform 0.3s ease; 
}
.sidebar h1 { color: var(--accent); font-size: 22px; margin-bottom: 40px; text-align: center; }
.nav button { 
    width: 100%; background: none; border: none; color: #94a3b8; padding: 12px; 
    text-align: left; border-radius: 8px; cursor: pointer; margin-bottom: 10px; 
    font-size: 15px; display: flex; align-items: center; gap: 10px; 
}
.nav button.active { background: #1e293b; color: #fff; }

.main { flex: 1; padding: 30px; margin-left: 240px; min-width: 0; transition: 0.3s; }

/* CABE√áALHO & CONQUISTAS RECENTES (Item 1) */
.header-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 30px; }
.card-slim { background: var(--card-bg); border-radius: 12px; padding: 15px 25px; border: 1px solid #1e293b66; display: flex; align-items: center; min-height: 125px; }
.profile-img-slim { width: 85px; height: 85px; border-radius: 50%; border: 3px solid var(--accent); object-fit: cover; margin-right: 20px; }
.recent-badges { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
.badge-mini { width: 35px; height: 35px; border-radius: 8px; background: #0f172a; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 1px solid var(--gold); }

/* MURAL DE CONQUISTAS (Item 5) */
.mural-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
.badge-card {
    background: #0f172a; padding: 20px; border-radius: 12px; text-align: center;
    border: 1px solid #1e293b; position: relative; cursor: help; transition: 0.3s;
}
.badge-card.unlocked { border-color: var(--gold); opacity: 1; }
.badge-card.locked { opacity: 0.3; filter: grayscale(1); }
.badge-tooltip {
    position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
    background: #000; color: #fff; padding: 10px; border-radius: 8px;
    width: 180px; font-size: 11px; visibility: hidden; opacity: 0; transition: 0.2s; z-index: 100;
    border: 1px solid var(--gold); pointer-events: none;
}
.badge-card:hover .badge-tooltip { visibility: visible; opacity: 1; }

/* SWITCH TAREFAS (Item 3) */
.switch { position: relative; display: inline-block; width: 40px; height: 22px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; inset: 0; background-color: #334155; transition: .4s; border-radius: 22px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--success); }
input:checked + .slider:before { transform: translateX(18px); }

/* CALEND√ÅRIO (Item 2) */
.habit-calendar { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
.habit-calendar th, .habit-calendar td { border: 1px solid #1e293b; padding: 8px; text-align: center; }
.habit-calendar th { color: var(--accent); background: #0f172a; }
.check-in { color: var(--success); font-weight: bold; font-size: 14px; }

/* RESPONSIVIDADE (Item 3) */
@media (max-width: 900px) {
    .menu-toggle { display: block; }
    .sidebar { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .main { margin-left: 0; padding: 70px 15px 20px 15px; }
    .header-grid, .grid-2 { grid-template-columns: 1fr; }
}

/* AUTH & POPUP */
#login-screen { position: fixed; inset: 0; background: var(--bg-main); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
.login-box { background: var(--card-bg); padding: 30px; border-radius: 15px; border: 1px solid var(--accent); width: 100%; max-width: 400px; text-align: center; }
#popup { position: fixed; top: 20px; right: 20px; background: var(--gold); color: #000; padding: 15px 25px; border-radius: 8px; font-weight: bold; display: none; z-index: 9999; }
.xp-bar { background: var(--accent); height: 100%; width: 0%; transition: 1s; }
.xp-container { background: #020617; border-radius: 10px; height: 10px; overflow: hidden; margin-top: 5px; width: 100%; }
</style>
</head>
<body>

<button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>

<div id="login-screen">
    <div class="login-box" id="auth-login">
        <h1 style="color: var(--accent);">LIFE DASH</h1>
        <input type="email" id="login-email" placeholder="E-mail">
        <input type="password" id="login-password" placeholder="Senha">
        <button onclick="fazerLogin()" style="width:100%; background:var(--accent); border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">Entrar</button>
        <p onclick="toggleAuth('register')" style="color:var(--accent); cursor:pointer; text-decoration:underline; margin-top:15px; font-size:14px;">Criar Nova Conta</p>
    </div>

    <div class="login-box" id="auth-register" style="display: none;">
        <h2>Nova Conta</h2>
        <div style="margin-bottom:15px;">
            <img id="regPreview" src="https://via.placeholder.com/85" style="width:85px; height:85px; border-radius:50%; object-fit:cover; border:2px solid var(--accent);">
            <input type="file" onchange="previewImagem(this, 'regPreview')" style="font-size:11px; display:block; margin:5px auto;">
        </div>
        <input id="regNome" placeholder="Nome Completo">
        <input id="regNascimento" placeholder="Nascimento (DD/MM/AAAA)" oninput="mascaraData(this)" maxlength="10">
        <select id="regSexo"><option value="">Sexo...</option><option>Masculino</option><option>Feminino</option></select>
        <input id="regEmail" placeholder="E-mail">
        <input type="password" id="regPassword" placeholder="Senha">
        <button onclick="fazerRegistro()" style="width:100%; background:var(--accent); border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">Cadastrar</button>
        <p onclick="toggleAuth('login')" style="color:var(--accent); cursor:pointer; text-decoration:underline; margin-top:15px; font-size:14px;">Voltar ao Login</p>
    </div>
</div>

<div id="popup"></div>

<div class="sidebar" id="sidebar">
  <h1>LIFE DASH</h1>
  <div class="nav">
    <button class="active" onclick="nav('home', this)">üè† Home</button>
    <button onclick="nav('conquistas', this)">üèÜ Conquistas</button>
    <button onclick="nav('perfil', this)">üë§ Perfil</button>
    <button onclick="nav('registros', this)">üìù Registros</button>
    <button onclick="nav('historico', this)">üìú Hist√≥rico</button>
    <button onclick="fazerLogout()" style="margin-top: 30px; color: var(--danger);">üö™ Sair</button>
  </div>
</div>

<div class="main">
  <div class="header-grid">
    <div class="card-slim">
      <img id="hFoto" class="profile-img-slim" src="https://via.placeholder.com/85">
      <div style="flex:1">
        <p><strong><span id="hNome">---</span></strong> | <span id="hIdade">--</span> anos</p>
        <p style="font-size:12px; color:var(--accent); margin:0;" id="hProfissao">---</p>
        <div class="xp-container"><div id="xpBar" class="xp-bar"></div></div>
        <div style="display:flex; justify-content:space-between; font-size:10px; margin-top:4px;">
            <span>N√≠vel <b id="hNivel">1</b></span> <span id="xpNumerico">0/100 XP</span>
        </div>
      </div>
    </div>
    <div class="card-slim" style="flex-direction:column; align-items:flex-start; justify-content:center;">
        <span style="font-size:11px; font-weight:bold; color:var(--gold);">CONQUISTAS RECENTES</span>
        <div id="homeBadges" class="recent-badges"></div>
    </div>
  </div>

  <div id="home" class="section active">
    <div class="grid-2" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        <div style="background:var(--card-bg); padding:20px; border-radius:12px;">
            <h3 style="color:var(--accent); border-bottom:1px solid #1e293b; padding-bottom:10px;">üöÄ Tarefas</h3>
            <div id="homeTarefas"></div>
        </div>
        <div>
            <div style="background:var(--card-bg); padding:20px; border-radius:12px; margin-bottom:20px;">
                <h3 style="color:var(--accent); border-bottom:1px solid #1e293b; padding-bottom:10px;">üìÖ H√°bitos (Semanal)</h3>
                <div id="calHabitos"></div>
            </div>
            <div style="background:var(--card-bg); padding:20px; border-radius:12px;">
                <h3 onclick="toggleCharts()" style="cursor:pointer; color:var(--accent);">üìä Estat√≠sticas ‚ñº</h3>
                <div id="chartsContainer" style="display:none; height:200px;"><canvas id="chartBarras"></canvas></div>
            </div>
        </div>
    </div>
  </div>

  <div id="conquistas" class="section">
    <div style="background:var(--card-bg); padding:25px; border-radius:12px;">
        <h3 style="color:var(--accent); border-bottom:1px solid #1e293b; padding-bottom:15px; margin-bottom:20px;">üèÜ Mural de Conquistas</h3>
        <div id="muralConquistas" class="mural-grid"></div>
    </div>
  </div>

  <div id="perfil" class="section">
    <div style="background:var(--card-bg); padding:25px; border-radius:12px;">
        <h3>üë§ Editar Perfil</h3>
        <div style="display:grid; grid-template-columns: 150px 1fr; gap:30px;">
            <div style="text-align:center;">
                <img id="pPreview" src="https://via.placeholder.com/150" style="width:150px; height:150px; border-radius:50%; object-fit:cover; border:4px solid var(--accent);">
                <input type="file" onchange="previewImagem(this, 'pPreview')" style="font-size:12px; margin-top:10px; width:100%;">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input id="pNome" placeholder="Nome">
                <input id="pNascimento" placeholder="Nascimento (DD/MM/AAAA)" oninput="mascaraData(this)" maxlength="10">
                <input id="pProfissao" placeholder="Profiss√£o">
                <select id="pSexo"><option>Masculino</option><option>Feminino</option></select>
                <input id="pFrase" placeholder="Frase de efeito" style="grid-column: span 2;">
                <button onclick="salvarPerfilFirebase()" style="grid-column: span 2; background:var(--accent); border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">üíæ Salvar Dados na Nuvem</button>
            </div>
        </div>
    </div>
  </div>

  <div id="registros" class="section">
    <div style="background:var(--card-bg); padding:25px; border-radius:12px;">
        <h3>üìù Gerenciar Sistema</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <p style="color:var(--accent); font-size:12px; font-weight:bold;">CATEGORIAS</p>
                <div style="display:flex; gap:5px;"><input id="regCatNome" placeholder="Nome..."><button onclick="addCat()">+</button></div>
                <p style="color:var(--accent); font-size:12px; font-weight:bold; margin-top:15px;">TAREFAS</p>
                <select id="regTarCat"></select>
                <div style="display:flex; gap:5px;"><input id="regTarNome" placeholder="Nome..."><button onclick="addTar()">+</button></div>
                <p style="color:var(--accent); font-size:12px; font-weight:bold; margin-top:15px;">H√ÅBITOS</p>
                <div style="display:flex; gap:5px;"><input id="regHabNome" placeholder="Nome..."><button onclick="addHab()">+</button></div>
            </div>
            <div id="listagemGeral" style="font-size:13px; background:#0f172a; padding:15px; border-radius:8px; border:1px solid #1e293b;">
                <strong>Estrutura Atual:</strong>
                <div id="listCats"></div>
            </div>
        </div>
    </div>
  </div>

  <div id="historico" class="section"><div style="background:var(--card-bg); padding:25px; border-radius:12px;"><h3>üìú Hist√≥rico</h3><div id="listHist"></div></div></div>
</div>

<script>
// --- CONFIGURA√á√ÉO ---
const firebaseConfig = {
  apiKey: "AIzaSyBkSJDH_aEVsp-LSNGm4XBqWoo_FUIJYNo",
  authDomain: "life-dash-e33f2.firebaseapp.com",
  projectId: "life-dash-e33f2",
  storageBucket: "life-dash-e33f2.firebasestorage.app",
  messagingSenderId: "270639106877",
  appId: "1:270639106877:web:92c8ec9353c6bacb485354"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const sndPlin = new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'); 
const sndFanfare = new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3');
const sndLevelUp = new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3');

let S = { perfil: {nome:"", nascimento:"", sexo:"", profissao:"", frase:"", foto:""}, categorias:[], tarefas:[], habitos:[], hist:[], xp:0, badges_unlocked:[], lastReset:"" };
let openCats = {};
let tempFoto = "";

const BADGES_DB = [
    {id:'1', icon:'ü¶â', title:'Coruja', desc:'Completou tarefas √† noite.', xp: 50, req:(s)=>s.hist.filter(h=>h.tipo==='T' && h.hora >= 20).length >= 5},
    {id:'2', icon:'üöÄ', title:'Explorador', desc:'Chegou ao N√≠vel 2.', xp: 100, req:(s)=>xpInfo(s.xp).n >= 2},
    {id:'3', icon:'üî•', title:'Foco Total', desc:'H√°bito ativo por 7 dias.', xp: 150, req:(s)=>s.habitos.some(h=>h.total >= 7)},
    {id:'4', icon:'üèÜ', title:'Elite', desc:'Acumulou 500 XP.', xp: 200, req:(s)=>s.xp >= 500}
];

// --- CORE FUNCTIONS ---
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
function toggleAuth(m) { document.getElementById('auth-login').style.display = m==='login'?'block':'none'; document.getElementById('auth-register').style.display = m==='register'?'block':'none'; }

auth.onAuthStateChanged(user => {
    if(user && user.emailVerified) {
        document.getElementById('login-screen').style.display = 'none';
        db.collection("users").doc(user.uid).onSnapshot(doc => {
            if(doc.exists) { 
                S = doc.data(); 
                verificarResetDiario();
                render(); 
            }
        });
    } else { document.getElementById('login-screen').style.display = 'flex'; }
});

function verificarResetDiario() {
    const hoje = new Date().toLocaleDateString('pt-BR');
    if(S.lastReset !== hoje) {
        S.tarefas.forEach(t => t.status = 'pendente'); // Reset para switch
        S.lastReset = hoje;
        salvar();
    }
}

function render() {
    const l = xpInfo(S.xp);
    document.getElementById("hNome").innerText = S.perfil.nome || "Usu√°rio";
    document.getElementById("hIdade").innerText = calcularIdade(S.perfil.nascimento);
    document.getElementById("hNivel").innerText = l.n;
    document.getElementById("xpBar").style.width = l.p + "%";
    document.getElementById("xpNumerico").innerText = `${Math.floor(l.cur)}/${Math.floor(l.max)} XP`;
    document.getElementById("hFoto").src = S.perfil.foto || "https://via.placeholder.com/85";
    document.getElementById("hProfissao").innerText = S.perfil.profissao || "Life Dasher";

    // Item 1: Recentes
    document.getElementById('homeBadges').innerHTML = S.badges_unlocked.slice(-5).map(id => {
        const b = BADGES_DB.find(x => x.id === id);
        return `<div class="badge-mini">${b.icon}</div>`;
    }).join("");

    // Item 2 e 5: Mural
    document.getElementById('muralConquistas').innerHTML = BADGES_DB.map(b => {
        const ok = S.badges_unlocked.includes(b.id);
        return `
        <div class="badge-card ${ok ? 'unlocked' : 'locked'}">
            <span style="font-size:40px">${b.icon}</span>
            <p style="font-weight:bold; font-size:12px; margin:5px 0;">${b.title}</p>
            <div class="badge-tooltip">
                <strong>${b.title}</strong><br>${b.desc}<br><span style="color:var(--gold)">+${b.xp} XP</span>
            </div>
        </div>`;
    }).join("");

    // Item 3: Tarefas com Switch
    let tarHtml = "";
    S.categorias.forEach(cat => {
        const ts = S.tarefas.filter(t => t.cat === cat);
        tarHtml += `<div onclick="toggleCat('${cat}')" style="background:#0f172a; padding:10px; border-radius:8px; margin-top:8px; cursor:pointer; font-size:13px; font-weight:bold; border:1px solid #1e293b;">${cat}</div><div style="display:${openCats[cat]?'block':'none'}; padding:0 10px;">`;
        ts.forEach(t => {
            const idx = S.tarefas.indexOf(t);
            tarHtml += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #1e293b66; align-items:center; font-size:14px;">
                <span>${t.nome}</span>
                <label class="switch"><input type="checkbox" ${t.status==='concluido'?'checked':''} onchange="toggleTarefa(${idx})"><span class="slider"></span></label>
            </div>`;
        });
        tarHtml += `</div>`;
    });
    document.getElementById("homeTarefas").innerHTML = tarHtml;

    // Item 2: Calend√°rio
    renderHabitosCalendario();
    checkBadges();
}

function renderHabitosCalendario() {
    const dias = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
    const hoje = new Date();
    const start = new Date(hoje); start.setDate(hoje.getDate() - hoje.getDay());
    let h = `<table class="habit-calendar"><tr><th>H√°bito</th>`;
    const datas = [];
    for(let i=0; i<7; i++){
        let d = new Date(start); d.setDate(start.getDate()+i);
        datas.push(d.toLocaleDateString('pt-BR'));
        h += `<th>${dias[i]}<br>${d.getDate()}</th>`;
    }
    h += `</tr>`;
    S.habitos.forEach(hab => {
        h += `<tr><td style="text-align:left; font-weight:bold;">${hab.nome}</td>`;
        datas.forEach(dt => {
            const ok = S.hist.some(r => r.nome === hab.nome && r.data === dt);
            h += `<td>${ok ? '<span class="check-in">‚úî</span>' : '¬∑'}</td>`;
        });
        h += `</tr>`;
    });
    document.getElementById('calHabitos').innerHTML = h + `</table>`;
}

// --- UTILIDADES ---
function xpInfo(xp) { let n=1, ac=0, pr=100; while(xp>=pr){ n++; ac=pr; pr+=Math.floor(150*Math.pow(1.2,n-1)); } return {n, p:((xp-ac)/(pr-ac))*100, cur:xp-ac, max:pr-ac}; }
function calcularIdade(n) { if(!n) return "--"; const b = n.split('/'); const d = new Date(b[2], b[1]-1, b[0]); const h = new Date(); let i = h.getFullYear()-d.getFullYear(); if(h.getMonth()<d.getMonth()||(h.getMonth()==d.getMonth()&&h.getDate()<d.getDate())) i--; return i; }
function nav(id, btn) { 
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active")); 
    document.getElementById(id).classList.add("active"); 
    document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active")); 
    btn.classList.add("active");
    if(window.innerWidth <= 900) toggleSidebar(); 
}
function mascaraData(i) {
    let v = i.value.replace(/\D/g,'');
    if(v.length > 2) v = v.substring(0,2) + '/' + v.substring(2);
    if(v.length > 5) v = v.substring(0,5) + '/' + v.substring(5,9);
    i.value = v;
}
function toggleTarefa(idx) {
    const t = S.tarefas[idx];
    const hoje = new Date().toLocaleDateString('pt-BR');
    if(t.status === 'pendente') {
        t.status = 'concluido'; S.xp += 10;
        S.hist.push({nome:t.nome, data:hoje, tipo:'T', cat:t.cat, hora:new Date().getHours(), xpGanhos:10});
        sndPlin.play();
    } else {
        t.status = 'pendente'; S.xp = Math.max(0, S.xp - 10);
        const hi = S.hist.findLastIndex(h => h.nome === t.nome && h.data === hoje);
        if(hi > -1) S.hist.splice(hi, 1);
    }
    salvar();
}
function salvar() { db.collection("users").doc(auth.currentUser.uid).set(S); }
function toggleCat(c) { openCats[c] = !openCats[c]; render(); }
function checkBadges() { 
    BADGES_DB.forEach(b => { 
        if (!S.badges_unlocked.includes(b.id) && b.req(S)) { 
            S.badges_unlocked.push(b.id); S.xp += b.xp; sndFanfare.play(); popup(`üèÜ CONQUISTA: ${b.title}`); salvar();
        } 
    }); 
}
function previewImagem(input, target) {
    if(input.files && input.files[0]){
        const reader = new FileReader();
        reader.onload = (e) => {
            tempFoto = e.target.result;
            document.getElementById(target).src = tempFoto;
        };
        reader.readAsDataURL(input.files[0]);
    }
}
function salvarPerfilFirebase() {
    S.perfil.nome = document.getElementById("pNome").value;
    S.perfil.nascimento = document.getElementById("pNascimento").value;
    S.perfil.profissao = document.getElementById("pProfissao").value;
    S.perfil.sexo = document.getElementById("pSexo").value;
    S.perfil.frase = document.getElementById("pFrase").value;
    if(tempFoto) S.perfil.foto = tempFoto;
    salvar(); popup("Sincronizado!");
}
function popup(m){ const p=document.getElementById("popup"); p.innerText=m; p.style.display="block"; setTimeout(()=>p.style.display="none",3000); }
function toggleCharts() { const c = document.getElementById('chartsContainer'); c.style.display = c.style.display === 'none' ? 'block' : 'none'; }
function fazerLogout() { auth.signOut().then(() => location.reload()); }
// Fun√ß√µes de Registro e Login mantidas conforme padr√£o anterior...
</script>
</body>
</html>
